<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tracky Pro V5</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #0f172a; --surface: #1e293b; --primary: #3b82f6; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --text: #f8fafc; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Cairo', sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 90px; }

        /* HEADER & LOCK */
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .pin-dots { display: flex; gap: 15px; margin-bottom: 30px; }
        .pin-dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid #94a3b8; }
        .pin-dot.filled { background: var(--primary); border-color: var(--primary); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .num-btn { width: 65px; height: 65px; border-radius: 50%; background: var(--surface); color: white; font-size: 22px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; }

        .header { padding: 15px 20px; background: rgba(15, 23, 42, 0.95); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        
        /* CARDS */
        .card { background: var(--surface); border-radius: 16px; padding: 15px; margin: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .balance-card { text-align: center; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .total-amount { font-size: 34px; font-weight: 800; margin: 10px 0; }
        
        /* ANALYSIS GRID */
        .biz-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #334155; font-size: 13px; }
        .biz-row:last-child { border: none; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #334155; margin-left: 5px; }

        /* QUICK ACTIONS */
        .quick-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px; }
        .quick-btn { background: var(--surface); border: 1px solid #334155; padding: 10px 5px; border-radius: 12px; text-align: center; font-size: 11px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }

        /* TABS */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* NAV & MODAL */
        .nav { position: fixed; bottom: 0; width: 100%; background: #0f172a; padding: 10px 0; display: flex; justify-content: space-around; border-top: 1px solid #334155; z-index: 200; }
        .nav-item { text-align: center; font-size: 10px; opacity: 0.6; transition: 0.3s; }
        .nav-item.active { opacity: 1; color: var(--primary); transform: translateY(-3px); }
        .nav-icon { font-size: 20px; margin-bottom: 4px; display: block; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal-box { background: var(--surface); width: 100%; max-width: 500px; padding: 25px; border-radius: 25px 25px 0 0; max-height: 90vh; overflow-y: auto; }
        
        input, select { width: 100%; padding: 14px; background: var(--bg); border: 1px solid #334155; color: white; border-radius: 12px; margin-bottom: 10px; font-family: 'Cairo'; outline: none; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .fab { position: fixed; bottom: 85px; left: 20px; width: 55px; height: 55px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4); z-index: 190; cursor: pointer; }
        
        .advice-box { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); padding: 10px; border-radius: 8px; font-size: 11px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h3>Tracky Secure ğŸ”’</h3>
        <p style="font-size:12px; opacity:0.6; margin-bottom:20px;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 0000)</p>
        <div class="pin-dots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <div class="numpad">
            <button class="num-btn" onclick="enterPin(1)">1</button>
            <button class="num-btn" onclick="enterPin(2)">2</button>
            <button class="num-btn" onclick="enterPin(3)">3</button>
            <button class="num-btn" onclick="enterPin(4)">4</button>
            <button class="num-btn" onclick="enterPin(5)">5</button>
            <button class="num-btn" onclick="enterPin(6)">6</button>
            <button class="num-btn" onclick="enterPin(7)">7</button>
            <button class="num-btn" onclick="enterPin(8)">8</button>
            <button class="num-btn" onclick="enterPin(9)">9</button>
            <button class="num-btn" style="visibility:hidden"></button>
            <button class="num-btn" onclick="enterPin(0)">0</button>
            <button class="num-btn" style="color:#ef4444" onclick="clearPin()">âŒ«</button>
        </div>
    </div>

    <div id="app-content" style="display:none">
        <div class="header">
            <div style="font-weight:800; font-size:18px;">Tracky ERP V5</div>
            <button onclick="exportData()" style="background:none; border:none; color:#f59e0b; font-size:18px;"><i class="fas fa-save"></i></button>
        </div>

        <div id="tab-home" class="tab-content active">
            <div class="card balance-card">
                <div style="font-size: 12px; opacity: 0.7;">ØµØ§ÙÙŠ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</div>
                <div class="total-amount" id="net-balance">0</div>
                <div style="display:flex; justify-content:center; gap:15px; font-size:11px;">
                    <span style="color:#ef4444">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ÙÙŠØ²Ø§: <span id="visa-debt">0</span></span>
                    <span style="color:#10b981">Ù„Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ØºÙŠØ±: <span id="my-credits">0</span></span>
                </div>
            </div>

            <div class="quick-grid">
                <div class="quick-btn" onclick="quickAdd('Ø®Ø¶Ø§Ø±/ÙØ§ÙƒÙ‡Ø©', 'groceries')"><i class="fas fa-carrot" style="color:#10b981"></i> Ø®Ø¶Ø§Ø±</div>
                <div class="quick-btn" onclick="quickAdd('Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª', 'groceries')"><i class="fas fa-shopping-cart" style="color:#3b82f6"></i> Ù…Ø§Ø±ÙƒØª</div>
                <div class="quick-btn" onclick="quickAdd('ØµÙŠØ¯Ù„ÙŠØ©/Ø¯ÙˆØ§Ø¡', 'family')"><i class="fas fa-pills" style="color:#ef4444"></i> Ø¯ÙˆØ§Ø¡</div>
                <div class="quick-btn" onclick="quickAdd('Ø¨Ù†Ø²ÙŠÙ†', 'car')"><i class="fas fa-gas-pump" style="color:#f59e0b"></i> Ø¨Ù†Ø²ÙŠÙ†</div>
            </div>

            <div class="card">
                <h4 style="margin:0 0 10px 0;">ğŸ“ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h4>
                <div id="recent-history"></div>
            </div>
        </div>

        <div id="tab-analysis" class="tab-content">
            <h2 style="padding:0 15px;">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</h2>
            
            <div class="card">
                <h3 style="color:#8b5cf6">ğŸ“ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³</h3>
                <div id="teaching-stats"></div>
            </div>

            <div class="card">
                <h3 style="color:#10b981">ğŸ¥ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h3>
                <div id="clinic-stats"></div>
            </div>

            <div class="card">
                <h3>ğŸ” Ø¨Ø­Ø« Ø°ÙƒÙŠ ÙÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
                <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø© (Ù†Ø³ÙƒØ§ÙÙŠÙ‡...)" onkeyup="analyzeItem(this.value)">
                <div id="analysis-result" style="font-size:12px; margin-top:10px;"></div>
            </div>
        </div>

        <div id="tab-services" class="tab-content">
            <div class="card">
                <h3>ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h3>
                <button onclick="openModal('modal-oil')" class="btn" style="background:#3b82f6; padding:10px;">ØªØ³Ø¬ÙŠÙ„ ØµÙŠØ§Ù†Ø©</button>
                <div id="car-info" style="font-size:12px; margin-top:10px;"></div>
            </div>

            <div class="card">
                <h3>ğŸ”„ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆÙÙˆØ§ØªÙŠØ±</h3>
                <div id="subs-alert-box"></div>
                <button onclick="openModal('modal-sub')" class="btn" style="background:#334155; padding:10px; margin-top:10px;">+ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>

        <div class="fab" onclick="openModal('modal-trans')">+</div>

        <div class="nav">
            <div class="nav-item active" onclick="switchTab('tab-home', this)"><i class="fas fa-home nav-icon"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
            <div class="nav-item" onclick="switchTab('tab-analysis', this)"><i class="fas fa-chart-line nav-icon"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
            <div class="nav-item" onclick="switchTab('tab-services', this)"><i class="fas fa-cogs nav-icon"></i> Ø®Ø¯Ù…Ø§Øª</div>
        </div>
    </div>

    <div class="modal" id="modal-trans">
        <div class="modal-box">
            <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©</h3>
            <select id="t-type" onchange="updateCategories()">
                <option value="expense">ğŸ’¸ Ù…ØµØ±ÙˆÙ</option>
                <option value="income">ğŸ’° Ø¥ÙŠØ±Ø§Ø¯</option>
            </select>
            
            <select id="t-cat">
                </select>

            <input type="number" id="t-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            
            <div id="smart-inputs">
                <input type="text" id="t-item" list="items-list" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯ (Ø§Ø¨Ø­Ø«...)" oninput="checkAdvice()">
                <datalist id="items-list"></datalist>
                <div id="smart-advice" class="advice-box"></div>
                <input type="text" id="t-vendor" placeholder="Ø§Ù„Ù…ÙƒØ§Ù† (ÙƒØ§Ø±ÙÙˆØ±ØŒ ÙƒØ´Ùƒ..)">
            </div>

            <select id="t-method">
                <option value="cash">ğŸ’µ ÙƒØ§Ø´</option>
                <option value="visa">ğŸ’³ ÙÙŠØ²Ø§ (Ø¢Ø¬Ù„)</option>
            </select>

            <button class="btn btn-primary" onclick="saveTrans()">Ø­ÙØ¸</button>
            <button class="btn" style="background:transparent; color:#94a3b8" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="modal" id="modal-oil">
        <div class="modal-box">
            <h3>ØµÙŠØ§Ù†Ø© Ø³ÙŠØ§Ø±Ø©</h3>
            <input type="number" id="o-km" placeholder="Ø§Ù„Ø¹Ø¯Ø§Ø¯ (KM)">
            <input type="text" id="o-note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
            <input type="number" id="o-cost" placeholder="Ø§Ù„ØªÙƒÙ„ÙØ©">
            <button class="btn btn-primary" onclick="saveOil()">Ø­ÙØ¸</button>
            <button class="btn" style="background:transparent" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="modal" id="modal-sub">
        <div class="modal-box">
            <h3>Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯</h3>
            <input type="text" id="s-name" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="number" id="s-cost" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©">
            <input type="number" id="s-day" placeholder="ÙŠÙˆÙ… Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (1-30)">
            <button class="btn btn-primary" onclick="saveSub()">Ø­ÙØ¸</button>
            <button class="btn" style="background:transparent" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        // CONFIG & DATA
        const categories = {
            income: [
                {val: 'clinic_center', txt: 'ğŸ¥ Ø¹ÙŠØ§Ø¯Ø© - Ø§Ù„Ù…Ø±ÙƒØ²'},
                {val: 'clinic_private', txt: 'ğŸ¥ Ø¹ÙŠØ§Ø¯Ø© - Ø­Ø§Ù„Ø§Øª Ø®Ø§ØµØ©'},
                {val: 'clinic_meds', txt: 'ğŸ’Š Ø¹ÙŠØ§Ø¯Ø© - Ø£Ø¯ÙˆÙŠØ©'},
                {val: 'clinic_hosp', txt: 'ğŸ¥ Ù…Ø³ØªØ´ÙÙ‰ (Ù…Ø±ØªØ¨)'},
                {val: 'teach_1', txt: 'ğŸ“ ØªØ¯Ø±ÙŠØ³ - ÙØ±Ù‚Ø© 1'},
                {val: 'teach_2', txt: 'ğŸ“ ØªØ¯Ø±ÙŠØ³ - ÙØ±Ù‚Ø© 2'},
                {val: 'teach_3', txt: 'ğŸ“ ØªØ¯Ø±ÙŠØ³ - ÙØ±Ù‚Ø© 3'},
                {val: 'teach_4', txt: 'ğŸ“ ØªØ¯Ø±ÙŠØ³ - ÙØ±Ù‚Ø© 4'},
                {val: 'platform', txt: 'ğŸ’» Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ©'},
                {val: 'consulting', txt: 'âš–ï¸ Ø§Ø³ØªØ´Ø§Ø±Ø§Øª'},
                {val: 'bike', txt: 'ğŸï¸ Ø¥ÙŠØ¬Ø§Ø± Ø¯Ø±Ø§Ø¬Ø©'},
                {val: 'other_in', txt: 'ğŸ’° Ø¥ÙŠØ±Ø§Ø¯ Ø¢Ø®Ø±'}
            ],
            expense: [
                {val: 'groceries', txt: 'ğŸ›’ Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª/Ø·Ù„Ø¨Ø§Øª'},
                {val: 'family', txt: 'ğŸ‘§ Ø¹Ø§Ø¦Ù„Ø©/Ø¯Ø±ÙˆØ³/ØªØ·Ø¹ÙŠÙ…'},
                {val: 'car', txt: 'ğŸš— Ø³ÙŠØ§Ø±Ø©/Ø¨Ù†Ø²ÙŠÙ†'},
                {val: 'bills', txt: 'ğŸ’¡ ÙÙˆØ§ØªÙŠØ±/Ø§Ø´ØªØ±Ø§ÙƒØ§Øª'},
                {val: 'personal', txt: 'ğŸ‘” Ø´Ø®ØµÙŠ/Ù†Ø³ÙƒØ§ÙÙŠÙ‡'},
                {val: 'clinic_ops', txt: 'ğŸ¥ Ù…ØµØ±ÙˆÙØ§Øª Ø¹ÙŠØ§Ø¯Ø©'},
                {val: 'teach_ops', txt: 'ğŸ“ Ù…ØµØ±ÙˆÙØ§Øª ØªØ¯Ø±ÙŠØ³'}
            ]
        };

        let db = {
            trans: JSON.parse(localStorage.getItem('erp_v5_trans')) || [],
            subs: JSON.parse(localStorage.getItem('erp_v5_subs')) || [],
            car: JSON.parse(localStorage.getItem('erp_v5_car')) || [],
            pin: localStorage.getItem('erp_v5_pin') || '0000'
        };

        // --- SECURITY ---
        let enteredPin = '';
        function enterPin(n) {
            if(enteredPin.length < 4) {
                enteredPin += n;
                updateDots();
                if(enteredPin.length === 4) checkPin();
            }
        }
        function clearPin() { enteredPin = ''; updateDots(); }
        function updateDots() { document.querySelectorAll('.pin-dot').forEach((d,i)=>d.classList.toggle('filled', i<enteredPin.length)); }
        function checkPin() {
            if(enteredPin === db.pin) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                initApp();
            } else { alert('Ø±Ù…Ø² Ø®Ø·Ø£'); enteredPin=''; updateDots(); }
        }

        // --- APP LOGIC ---
        function initApp() {
            updateCategories();
            renderBalance();
            renderHistory();
            renderBizStats();
            renderServices();
            populateAutoComplete();
        }

        function updateCategories() {
            const type = document.getElementById('t-type').value;
            const sel = document.getElementById('t-cat');
            sel.innerHTML = '';
            categories[type].forEach(c => {
                sel.innerHTML += `<option value="${c.val}">${c.txt}</option>`;
            });
            
            // Hide smart shopper inputs if Income
            document.getElementById('smart-inputs').style.display = type === 'expense' ? 'block' : 'none';
        }

        function renderBalance() {
            let liquid = 0, visa = 0, credit = 0;
            db.trans.forEach(t => {
                if(t.type === 'income') liquid += parseFloat(t.amount);
                else {
                    if(t.method === 'visa') visa += parseFloat(t.amount);
                    else liquid -= parseFloat(t.amount);
                }
            });
            document.getElementById('net-balance').innerText = liquid.toLocaleString() + ' Ø¬.Ù…';
            document.getElementById('visa-debt').innerText = visa.toLocaleString();
        }

        function renderBizStats() {
            // Calculate Totals per Category
            let stats = {};
            db.trans.forEach(t => {
                if(t.type === 'income') {
                    if(!stats[t.cat]) stats[t.cat] = 0;
                    stats[t.cat] += parseFloat(t.amount);
                }
            });

            // Helper to render
            const renderRows = (prefix, elId) => {
                const el = document.getElementById(elId);
                el.innerHTML = '';
                const cats = categories.income.filter(c => c.val.startsWith(prefix));
                let total = 0;
                cats.forEach(c => {
                    const val = stats[c.val] || 0;
                    total += val;
                    if(val > 0) {
                        el.innerHTML += `
                        <div class="biz-row">
                            <span>${c.txt}</span>
                            <span style="font-weight:bold">${val.toLocaleString()}</span>
                        </div>`;
                    }
                });
                if(total === 0) el.innerHTML = '<div style="opacity:0.5; font-size:12px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
                else el.innerHTML += `<div style="border-top:1px dashed #555; margin-top:5px; padding-top:5px; font-weight:bold; text-align:left;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toLocaleString()}</div>`;
            };

            renderRows('teach', 'teaching-stats');
            renderRows('clinic', 'clinic-stats');
        }

        function saveTrans() {
            const trans = {
                id: Date.now(),
                type: document.getElementById('t-type').value,
                cat: document.getElementById('t-cat').value,
                amount: document.getElementById('t-amount').value,
                item: document.getElementById('t-item').value,
                vendor: document.getElementById('t-vendor').value,
                method: document.getElementById('t-method').value,
                date: new Date().toLocaleDateString('en-GB')
            };

            if(!trans.amount) return;
            
            // Use Category Name as Item if Item is empty (for income)
            if(!trans.item && trans.type === 'income') {
                const catObj = categories.income.find(c => c.val === trans.cat);
                trans.item = catObj ? catObj.txt : trans.cat;
            }

            db.trans.unshift(trans);
            saveAll(); closeModal(); initApp();
            
            // Reset
            document.getElementById('t-amount').value = '';
            document.getElementById('t-item').value = '';
        }

        // Helper Functions (Same as V4 but optimized)
        function quickAdd(item, cat) {
            document.getElementById('t-type').value = 'expense';
            updateCategories();
            document.getElementById('t-cat').value = cat;
            document.getElementById('t-item').value = item;
            openModal('modal-trans');
            document.getElementById('t-amount').focus();
        }

        function checkAdvice() {
            const val = document.getElementById('t-item').value;
            if(val.length < 3) return;
            const history = db.trans.filter(t => t.item && t.item.includes(val));
            if(history.length > 0) {
                history.sort((a,b)=>parseFloat(a.amount)-parseFloat(b.amount));
                document.getElementById('smart-advice').style.display = 'block';
                document.getElementById('smart-advice').innerHTML = `ğŸ’¡ Ø£ÙØ¶Ù„ Ø³Ø¹Ø±: ${history[0].amount} (${history[0].vendor})`;
            }
        }

        function renderHistory() {
            const el = document.getElementById('recent-history');
            el.innerHTML = '';
            db.trans.slice(0, 20).forEach((t, idx) => {
                const color = t.type === 'income' ? '#10b981' : '#ef4444';
                el.innerHTML += `
                <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #333; font-size:13px;">
                    <div>
                        <div style="font-weight:600">${t.item || t.cat}</div>
                        <div style="font-size:10px; opacity:0.6">${t.date} | ${t.vendor||''}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="color:${color}; font-weight:bold">${t.amount}</span>
                        <i class="fas fa-trash" style="color:#ef4444; cursor:pointer;" onclick="delTrans(${idx})"></i>
                    </div>
                </div>`;
            });
        }

        function delTrans(i) {
            if(confirm('Ø­Ø°ÙØŸ')) { db.trans.splice(i,1); saveAll(); initApp(); }
        }

        function saveOil() {
            db.car.push({
                km: document.getElementById('o-km').value,
                note: document.getElementById('o-note').value,
                date: new Date().toLocaleDateString('en-GB')
            });
            const cost = document.getElementById('o-cost').value;
            if(cost > 0) {
                db.trans.unshift({id:Date.now(), type:'expense', amount:cost, cat:'car', item:'ØµÙŠØ§Ù†Ø©', date: new Date().toLocaleDateString('en-GB'), method:'cash'});
            }
            saveAll(); closeModal(); initApp();
        }

        function saveSub() {
            db.subs.push({
                name: document.getElementById('s-name').value,
                cost: document.getElementById('s-cost').value,
                day: document.getElementById('s-day').value
            });
            saveAll(); closeModal(); initApp();
        }

        function renderServices() {
            // Car
            const lastCar = db.car[db.car.length-1];
            document.getElementById('car-info').innerText = lastCar ? `Ø¢Ø®Ø± ØµÙŠØ§Ù†Ø©: ${lastCar.date} (${lastCar.km} ÙƒÙ…)` : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª';
            
            // Subs
            const box = document.getElementById('subs-alert-box');
            box.innerHTML = '';
            const today = new Date().getDate();
            db.subs.forEach(s => {
                const diff = s.day - today;
                const color = (diff >= 0 && diff <= 3) ? '#ef4444' : '#94a3b8';
                box.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:12px; padding:5px 0; border-bottom:1px dashed #333;">
                    <span>${s.name} (${s.cost})</span><span style="color:${color}">ÙŠÙˆÙ… ${s.day}</span>
                </div>`;
            });
        }

        function populateAutoComplete() {
            const dl = document.getElementById('items-list');
            dl.innerHTML = '';
            [...new Set(db.trans.map(t=>t.item))].forEach(i => dl.innerHTML += `<option value="${i}">`);
        }
        
        function analyzeItem(v) {
             if(v.length < 2) return;
             const res = db.trans.filter(t=>t.item && t.item.includes(v));
             const total = res.reduce((a,b)=>a+parseFloat(b.amount),0);
             document.getElementById('analysis-result').innerHTML = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¬.Ù… (${res.length} Ø¹Ù…Ù„ÙŠØ©)`;
        }

        function saveAll() {
            localStorage.setItem('erp_v5_trans', JSON.stringify(db.trans));
            localStorage.setItem('erp_v5_subs', JSON.stringify(db.subs));
            localStorage.setItem('erp_v5_car', JSON.stringify(db.car));
        }

        function exportData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            a.download = "Tracky_Backup.json";
            a.click();
        }

        // Utils
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function switchTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
    </script>
</body>
</html>
