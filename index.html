<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tracky Pro ERP</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #050505;
            --surface: rgba(30, 30, 35, 0.7);
            --primary: #2563eb;    /* University Blue */
            --medical: #059669;    /* Clinic Green */
            --life: #d97706;       /* Home Orange */
            --danger: #dc2626;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --glass-border: 1px solid rgba(255,255,255,0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Cairo', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; overflow-x: hidden; }
        
        /* GLOBAL BLUR CLASS */
        body.hide-amounts .amount-val { filter: blur(6px); user-select: none; }

        /* HEADER */
        .header {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(5,5,5,0.8); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100; border-bottom: var(--glass-border);
        }
        
        /* CUSTOM LOGO */
        .logo-shield {
            width: 35px; height: 35px; background: linear-gradient(135deg, var(--primary), var(--medical));
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 18px; color: white;
        }

        /* CARDS */
        .card { background: var(--surface); border-radius: 16px; padding: 15px; margin: 15px 15px 10px 15px; border: var(--glass-border); position: relative; }
        .stat-card { text-align: center; padding: 20px; background: linear-gradient(145deg, #1a1a1a, #0a0a0a); }
        
        /* STATS BAR */
        .stats-bar { display: flex; gap: 10px; overflow-x: auto; padding: 0 15px 10px 15px; }
        .mini-stat { background: var(--surface); padding: 10px; border-radius: 12px; min-width: 100px; text-align: center; border: var(--glass-border); }
        .mini-stat label { font-size: 10px; color: var(--text-muted); display: block; }
        .mini-stat val { font-weight: bold; font-size: 14px; }

        /* LISTS */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); margin-bottom: 8px; border-radius: 10px; }
        .list-item:hover { background: rgba(255,255,255,0.05); }

        /* NOTIFICATIONS CENTER */
        .notif-row { display: flex; gap: 10px; padding: 10px; border-bottom: 1px dashed #333; align-items: center; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        /* TABS */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* NAV & FAB */
        .nav { position: fixed; bottom: 0; width: 100%; background: #0a0a0a; padding: 10px 0; display: flex; justify-content: space-around; border-top: var(--glass-border); z-index: 200; }
        .nav-item { text-align: center; font-size: 10px; opacity: 0.5; transition: 0.3s; cursor: pointer; }
        .nav-item.active { opacity: 1; transform: translateY(-3px); }
        .nav-item.active.uni { color: var(--primary); }
        .nav-item.active.clinic { color: var(--medical); }
        .nav-item.active.home { color: var(--life); }

        .fab {
            position: fixed; bottom: 80px; right: 20px; width: 55px; height: 55px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 190; cursor: pointer; transition: 0.3s;
        }
        /* Dynamic Colors for FAB */
        .fab.uni { background: var(--primary); }
        .fab.clinic { background: var(--medical); }
        .fab.home { background: var(--life); }
        .fab.main { background: #6366f1; }

        /* MODALS & FORMS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal-box { background: #151515; width: 100%; max-width: 500px; padding: 25px; border-radius: 25px 25px 0 0; max-height: 90vh; overflow-y: auto; border-top: 1px solid #333; }
        
        input, select { width: 100%; padding: 12px; background: #222; border: 1px solid #333; color: white; border-radius: 8px; margin-bottom: 10px; font-family: 'Cairo'; outline:none; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* CONTEXT MENU GRID */
        .ctx-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .ctx-btn { background: #222; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #333; color: #fff; cursor: pointer; }
        .ctx-btn i { font-size: 20px; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="logo-shield">T</div>
            <div style="font-size:12px; line-height:1.2">
                <div style="font-weight:bold">TRACKY</div>
                <div style="font-size:10px; opacity:0.6">Engineer Edition</div>
            </div>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div onclick="toggleLang()" style="font-size:12px; border:1px solid #333; padding:2px 8px; border-radius:4px;">EN</div>
            <i class="fas fa-eye" id="eye-btn" onclick="togglePrivacy()"></i>
            <i class="fas fa-bell" onclick="openModal('modal-notifs')"></i>
        </div>
    </div>

    <div id="tab-main" class="tab-content active">
        <div class="card stat-card">
            <div style="font-size:12px; color:var(--text-muted)">ØµØ§ÙÙŠ Ø§Ù„Ø«Ø±ÙˆØ© (Ø¨Ø¯ÙˆÙ† Ø¯ÙŠÙˆÙ†)</div>
            <div class="amount-val" id="net-worth" style="font-size:32px; font-weight:900; margin:10px 0;">0</div>
            <div style="display:flex; justify-content:center; gap:20px; font-size:11px;">
                <span style="color:var(--medical)">Ø³ÙŠÙˆÙ„Ø©: <span id="cash-val" class="amount-val">0</span></span>
                <span style="color:var(--danger)">Ø¯ÙŠÙˆÙ†: <span id="debt-val" class="amount-val">0</span></span>
            </div>
        </div>

        <div class="card" style="border-right: 4px solid #6366f1;">
            <div style="display:flex; justify-content:space-between;">
                <h4 style="margin:0">ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h4>
                <button style="background:none; border:none; color:#6366f1; font-size:12px;" onclick="openModal('modal-ai-scan')">ğŸ“¸ ØªØ­Ù„ÙŠÙ„ ÙØ§ØªÙˆØ±Ø©</button>
            </div>
            <p id="ai-msg" style="font-size:11px; margin-top:5px; opacity:0.7">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ù†Ù…Ø· Ø§Ù„Ø¥Ù†ÙØ§Ù‚...</p>
        </div>

        <div class="card">
            <h4>ğŸ”” ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ø§Ø¬Ù„Ø©</h4>
            <div id="home-alerts"></div>
        </div>
    </div>

    <div id="tab-uni" class="tab-content">
        <div class="stats-bar">
            <div class="mini-stat"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</label><val id="uni-count">0</val></div>
            <div class="mini-stat"><label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</label><val id="uni-debt" class="amount-val" style="color:var(--danger)">0</val></div>
            <div class="mini-stat"><label>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø±</label><val id="uni-revenue" class="amount-val" style="color:var(--primary)">0</val></div>
        </div>

        <div class="card" style="padding:10px;">
            <div style="display:flex; gap:5px;">
                <input type="text" id="uni-search" placeholder="ğŸ” Ø¨Ø­Ø« (Ø§Ø³Ù…ØŒ Ø±Ù‚Ù…ØŒ ÙØ±Ù‚Ø©)..." onkeyup="renderStudentList()" style="margin:0;">
                <button onclick="openModal('modal-uni-settings')" style="width:40px; margin:0; background:#222; color:white; border:1px solid #333;"><i class="fas fa-sliders-h"></i></button>
            </div>
        </div>

        <div id="student-list-container" style="padding:0 15px;"></div>
    </div>

    <div id="tab-clinic" class="tab-content">
        <div class="stats-bar">
            <div class="mini-stat"><label>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</label><val id="clinic-today" class="amount-val">0</val></div>
            <div class="mini-stat"><label>ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„Ø¯ÙˆØ§Ø¡</label><val id="clinic-pharma-profit" class="amount-val" style="color:var(--medical)">0</val></div>
        </div>

        <div class="card">
            <h4 style="margin:0 0 10px 0;">ğŸ“ˆ Ù…Ø¤Ø´Ø± Ø§Ù„Ù†Ù…Ùˆ</h4>
            <canvas id="clinicChart" height="100"></canvas>
        </div>

        <div class="card">
            <h4>ğŸ¥ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</h4>
            <div class="list-item"><span>Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ (Ø±Ø§ØªØ¨)</span> <span class="amount-val" id="hosp-total">0</span></div>
            <div class="list-item"><span>Ø§Ù„Ù…Ø±ÙƒØ²</span> <span class="amount-val" id="center-total">0</span></div>
            <div class="list-item"><span>Ø§Ù„Ø®Ø§Øµ</span> <span class="amount-val" id="private-total">0</span></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4>ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</h4>
                <button style="font-size:10px; background:#222; color:white; border:1px solid #333; padding:2px 8px;" onclick="openModal('modal-drug-add')">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
            </div>
            <div id="drug-list"></div>
        </div>
    </div>

    <div id="tab-home-life" class="tab-content">
        <div class="card">
            <h3>ğŸ  Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨ÙŠØª</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="mini-stat"><label>Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</label><val class="amount-val" id="cat-market">0</val></div>
                <div class="mini-stat"><label>Ø¹Ø§Ø¦Ù„Ø©</label><val class="amount-val" id="cat-family">0</val></div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ”„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†</h3>
            <div id="subs-list"></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <span>ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø©</span>
                <span style="font-size:11px; opacity:0.6" id="car-next-oil">Ø¨Ø§Ù‚ÙŠ 0 ÙƒÙ…</span>
            </div>
            <div style="height:5px; background:#333; margin-top:5px; border-radius:5px;">
                <div id="oil-bar" style="width:100%; height:100%; background:var(--life); border-radius:5px;"></div>
            </div>
        </div>
    </div>

    <div id="main-fab" class="fab main" onclick="openContextModal()">
        <i class="fas fa-plus"></i>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="switchTab('tab-main', this, 'main')"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-item" onclick="switchTab('tab-uni', this, 'uni')"><i class="fas fa-university"></i> Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</div>
        <div class="nav-item" onclick="switchTab('tab-clinic', this, 'clinic')"><i class="fas fa-stethoscope"></i> Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</div>
        <div class="nav-item" onclick="switchTab('tab-home-life', this, 'home')"><i class="fas fa-couch"></i> Ø§Ù„Ø­ÙŠØ§Ø©</div>
    </div>

    <div class="modal" id="modal-context">
        <div class="modal-box">
            <h3 id="ctx-title" style="text-align:center; margin-bottom:20px;">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <div id="ctx-content" class="ctx-grid">
                </div>
            <button class="btn" style="background:transparent; color:#888" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="modal" id="modal-student">
        <div class="modal-box">
            <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ø§Ù„Ø¨ ğŸ“</h3>
            <input type="text" id="st-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø±Ø¨Ø§Ø¹ÙŠ">
            <input type="tel" id="st-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            <select id="st-year">
                <option value="1">Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
                <option value="2">Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
                <option value="3">Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</option>
                <option value="4">Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©</option>
            </select>
            <input type="number" id="st-subs" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©">
            <div style="font-size:11px; color:#666; margin-bottom:10px;">Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
            <button class="btn" style="background:var(--primary); color:white" onclick="saveStudent()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
    </div>

    <div class="modal" id="modal-trans">
        <div class="modal-box">
            <h3 id="trans-title">ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ©</h3>
            <input type="number" id="tr-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            <input type="text" id="tr-item" placeholder="Ø§Ù„ÙˆØµÙ (Ø¯ÙˆØ§Ø¡ØŒ ØµÙŠØ§Ù†Ø©ØŒ Ø§Ø³Ù…...)">
            <input type="hidden" id="tr-cat">
            <input type="hidden" id="tr-type">
            <button class="btn" style="background:#fff; color:#000" onclick="saveTransaction()">Ø­ÙØ¸</button>
        </div>
    </div>

    <div class="modal" id="modal-uni-settings">
        <div class="modal-box">
            <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h3>
            <label>Ø³Ø¹Ø± Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§Ù„ÙˆØ§Ø­Ø¯Ø©)</label>
            <input type="number" id="set-price-sub" placeholder="Ù…Ø«Ù„Ø§Ù‹ 200">
            <label>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØµØ© (Ø«Ø§Ø¨Øª Ù„Ù„Ø·Ø§Ù„Ø¨)</label>
            <input type="number" id="set-price-plat" placeholder="Ù…Ø«Ù„Ø§Ù‹ 100">
            <button class="btn" onclick="saveUniSettings()" style="background:var(--primary); color:white">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</button>
        </div>
    </div>

    <div class="modal" id="modal-notifs">
        <div class="modal-box">
            <h3>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
            <div id="notif-list"></div>
            <button class="btn" style="background:transparent" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        let db = {
            trans: [],
            students: [],
            inventory: [],
            patients: [],
            subs: [],
            car: { km: 0, last_oil: 0, limit: 5000 },
            uni_settings: { sub_price: 250, plat_price: 100 },
            lang: 'ar'
        };

        // Load
        const saved = localStorage.getItem('tracky_v7');
        if(saved) db = JSON.parse(saved);

        let currentTab = 'main';

        // --- INIT ---
        window.onload = function() {
            renderAll();
            setupChart();
        };

        function renderAll() {
            calcFinance();
            renderUni();
            renderClinic();
            renderHome();
            checkNotifs();
        }

        function save() {
            localStorage.setItem('tracky_v7', JSON.stringify(db));
            renderAll();
        }

        // --- LOGIC: CONTEXT FAB ---
        function switchTab(tabId, el, context) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.className = 'nav-item');
            el.classList.add('active', context); // Add color class
            
            currentTab = context;
            
            // Update FAB Look
            const fab = document.getElementById('main-fab');
            fab.className = `fab ${context}`;
        }

        function openContextModal() {
            const content = document.getElementById('ctx-content');
            const title = document.getElementById('ctx-title');
            content.innerHTML = '';

            if (currentTab === 'main') {
                title.innerText = "Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ø§Ù…";
                content.innerHTML = `
                    <div class="ctx-btn" onclick="openTransModal('income', 'other', 'Ø¥ÙŠØ±Ø§Ø¯ Ù…ØªÙ†ÙˆØ¹')"><i class="fas fa-wallet" style="color:#fff"></i> Ø¥ÙŠØ±Ø§Ø¯</div>
                    <div class="ctx-btn" onclick="openTransModal('expense', 'personal', 'Ù…ØµØ±ÙˆÙ Ø´Ø®ØµÙŠ')"><i class="fas fa-user" style="color:#fff"></i> Ø´Ø®ØµÙŠ</div>
                    <div class="ctx-btn" onclick="alert('Ù‚Ø±ÙŠØ¨Ø§Ù‹: ØªØ­ØµÙŠÙ„ Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø¯Ø±Ø§Ø¬Ø©')"><i class="fas fa-motorcycle" style="color:var(--life)"></i> Ø¯Ø±Ø§Ø¬Ø©</div>
                `;
            } else if (currentTab === 'uni') {
                title.innerText = "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©";
                content.innerHTML = `
                    <div class="ctx-btn" onclick="openModal('modal-student')"><i class="fas fa-user-plus" style="color:var(--primary)"></i> Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</div>
                    <div class="ctx-btn" onclick="openTransModal('expense', 'uni_ops', 'Ù…ØµØ±ÙˆÙ Ø¬Ø§Ù…Ø¹Ø©')"><i class="fas fa-file-invoice-dollar"></i> Ù…ØµØ±ÙˆÙ ØªØ´ØºÙŠÙ„</div>
                `;
            } else if (currentTab === 'clinic') {
                title.innerText = "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©";
                content.innerHTML = `
                    <div class="ctx-btn" onclick="openTransModal('income', 'clinic_visit', 'ÙƒØ´Ù Ø¹ÙŠØ§Ø¯Ø©')"><i class="fas fa-user-injured" style="color:var(--medical)"></i> ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯</div>
                    <div class="ctx-btn" onclick="openTransModal('income', 'clinic_drug', 'Ø¨ÙŠØ¹ Ø¯ÙˆØ§Ø¡')"><i class="fas fa-pills" style="color:#fff"></i> Ø¨ÙŠØ¹ Ø¯ÙˆØ§Ø¡</div>
                    <div class="ctx-btn" onclick="openTransModal('expense', 'clinic_stock', 'Ø´Ø±Ø§Ø¡ Ø£Ø¯ÙˆÙŠØ©')"><i class="fas fa-box-open" style="color:var(--danger)"></i> Ø´Ø±Ø§Ø¡ Ù…Ø®Ø²ÙˆÙ†</div>
                `;
            } else if (currentTab === 'home') {
                title.innerText = "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØª";
                content.innerHTML = `
                    <div class="ctx-btn" onclick="openTransModal('expense', 'market', 'Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª')"><i class="fas fa-shopping-cart" style="color:var(--life)"></i> Ù…Ø§Ø±ÙƒØª</div>
                    <div class="ctx-btn" onclick="openTransModal('expense', 'family', 'Ù…ØµØ±ÙˆÙ Ø¹Ø§Ø¦Ù„ÙŠ')"><i class="fas fa-home"></i> Ø¹Ø§Ø¦Ù„Ø©</div>
                    <div class="ctx-btn" onclick="openTransModal('expense', 'car', 'ØµÙŠØ§Ù†Ø©/Ø¨Ù†Ø²ÙŠÙ†')"><i class="fas fa-gas-pump"></i> Ø³ÙŠØ§Ø±Ø©</div>
                    <div class="ctx-btn" onclick="openTransModal('expense', 'sub', 'Ø§Ø´ØªØ±Ø§Ùƒ/Ù‚Ø³Ø·')"><i class="fas fa-sync"></i> Ø§Ø´ØªØ±Ø§Ùƒ</div>
                `;
            }
            
            openModal('modal-context');
        }

        // --- LOGIC: UNIVERSITY ---
        function saveStudent() {
            const s = {
                id: Date.now(),
                name: document.getElementById('st-name').value,
                phone: document.getElementById('st-phone').value,
                year: document.getElementById('st-year').value,
                subs_count: parseInt(document.getElementById('st-subs').value),
                reg_date: new Date().toLocaleDateString(),
                paid: 0,
                history: []
            };
            // Calc Total Logic
            s.total_due = (s.subs_count * db.uni_settings.sub_price) + parseInt(db.uni_settings.plat_price);
            
            db.students.push(s);
            save(); closeModal();
        }

        function renderUni() {
            document.getElementById('uni-count').innerText = db.students.length;
            
            // Revenue this month logic
            const thisMonth = new Date().getMonth();
            const rev = db.trans.filter(t => t.cat.startsWith('uni') && t.type=='income' && new Date(t.rawDate).getMonth() == thisMonth)
                                .reduce((a,b)=>a+parseFloat(b.amount),0);
            document.getElementById('uni-revenue').innerText = rev.toLocaleString();

            renderStudentList();
        }

        function renderStudentList() {
            const q = document.getElementById('uni-search').value.toLowerCase();
            const list = document.getElementById('student-list-container');
            list.innerHTML = '';
            
            let totalDebt = 0;

            db.students.filter(s => s.name.toLowerCase().includes(q) || s.phone.includes(q)).forEach(s => {
                const debt = s.total_due - s.paid;
                totalDebt += debt;
                
                list.innerHTML += `
                <div class="card" style="margin:5px 0; padding:10px; border-left:4px solid ${debt>0? 'var(--danger)':'var(--primary)'}">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <div style="font-weight:bold">${s.name}</div>
                            <div style="font-size:10px; color:#888">${s.reg_date} | ${s.phone}</div>
                        </div>
                        <div style="text-align:left">
                            <div style="font-size:10px;">Ø¨Ø§Ù‚ÙŠ Ø¹Ù„ÙŠÙ‡</div>
                            <div class="amount-val" style="font-weight:bold; color:${debt>0?'#ef4444':'#22c55e'}">${debt}</div>
                        </div>
                    </div>
                    ${debt > 0 ? `<button class="btn" style="padding:5px; margin-top:5px; background:#333; font-size:11px;" onclick="payStudent(${s.id})">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</button>` : ''}
                    <button class="btn" style="padding:5px; margin-top:5px; background:none; color:#ef4444; font-size:11px;" onclick="delStudent(${s.id})">Ø­Ø°Ù</button>
                </div>`;
            });
            document.getElementById('uni-debt').innerText = totalDebt.toLocaleString();
        }

        function payStudent(id) {
            const amount = prompt("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:");
            if(amount) {
                const idx = db.students.findIndex(s=>s.id===id);
                db.students[idx].paid += parseFloat(amount);
                // Add to Global Trans
                db.trans.push({
                    id: Date.now(), type:'income', amount: amount, cat:'uni_fees', 
                    item:`Ù‚Ø³Ø·: ${db.students[idx].name}`, date: new Date().toLocaleDateString(), rawDate: Date.now()
                });
                save();
            }
        }

        function saveUniSettings() {
            db.uni_settings.sub_price = document.getElementById('set-price-sub').value;
            db.uni_settings.plat_price = document.getElementById('set-price-plat').value;
            alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±! (Ø³ÙŠØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¬Ø¯Ø¯)');
            save(); closeModal();
        }

        function delStudent(id) {
            if(confirm('Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
                db.students = db.students.filter(s => s.id !== id);
                save();
            }
        }

        // --- LOGIC: CLINIC ---
        function renderClinic() {
            // Stats logic here (summing types)
            // ...
            // Simplified for brevity, fills the stat cards
        }

        // --- GENERIC TRANS ---
        function openTransModal(type, cat, placeholder) {
            closeModal(); // context
            document.getElementById('tr-type').value = type;
            document.getElementById('tr-cat').value = cat;
            document.getElementById('tr-item').placeholder = placeholder;
            document.getElementById('trans-title').innerText = type==='income' ? 'ØªØ³Ø¬ÙŠÙ„ Ø¥ÙŠØ±Ø§Ø¯' : 'ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ';
            openModal('modal-trans');
        }

        function saveTransaction() {
            db.trans.push({
                id: Date.now(),
                type: document.getElementById('tr-type').value,
                cat: document.getElementById('tr-cat').value,
                amount: document.getElementById('tr-amount').value,
                item: document.getElementById('tr-item').value,
                date: new Date().toLocaleDateString(),
                rawDate: Date.now()
            });
            save(); closeModal();
        }

        // --- SYSTEM ---
        function calcFinance() {
            let liquid = 0, debts = 0;
            db.trans.forEach(t => {
                if(t.type === 'income') liquid += parseFloat(t.amount);
                else liquid -= parseFloat(t.amount);
            });
            document.getElementById('net-worth').innerText = liquid.toLocaleString();
            document.getElementById('cash-val').innerText = liquid.toLocaleString();
        }

        function togglePrivacy() {
            document.body.classList.toggle('hide-amounts');
            const icon = document.getElementById('eye-btn');
            icon.className = document.body.classList.contains('hide-amounts') ? 'fas fa-eye-slash' : 'fas fa-eye';
        }

        function checkNotifs() {
            const list = document.getElementById('notif-list');
            const homeList = document.getElementById('home-alerts');
            list.innerHTML = ''; homeList.innerHTML = '';
            
            // Financial (Red)
            // Example: Check subscriptions
            
            // Events (Blue)
            // Example: Car oil
            
            // Dummy for UI
            const alertHTML = `<div class="notif-row"><div class="dot" style="background:var(--danger)"></div> <span>Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø¬Ù…Ø¹ÙŠØ© (5000Ø¬)</span></div>`;
            list.innerHTML += alertHTML;
            homeList.innerHTML += alertHTML;
        }

        // Chart.js (Clinic Growth)
        function setupChart() {
            const ctx = document.getElementById('clinicChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar'],
                    datasets: [{
                        label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯',
                        data: [12000, 15000, 13500],
                        borderColor: '#059669',
                        tension: 0.4
                    }]
                },
                options: { plugins: {legend: {display: false}}, scales: {x:{display:false}, y:{display:false}} }
            });
        }

        // Utils
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    </script>
</body>
</html>
