<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tracky Infinity</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-deep: #050509;
            --glass-surface: rgba(20, 20, 35, 0.65);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --neon-blue: #00f2ff;
            --neon-purple: #bd00ff;
            --neon-green: #00ff88;
            --neon-red: #ff0055;
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; font-family: 'Cairo', sans-serif;
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(189, 0, 255, 0.08), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(0, 242, 255, 0.08), transparent 25%);
            color: var(--text-main);
            padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* --- UTILS --- */
        .blur-sensitive { transition: filter 0.3s; }
        body.privacy-mode .blur-sensitive { filter: blur(8px); }
        .hidden { display: none !important; }

        /* --- HEADER & SEARCH --- */
        .infinity-header {
            padding: 15px 20px;
            background: rgba(5, 5, 9, 0.85);
            backdrop-filter: blur(20px);
            position: sticky; top: 0; z-index: 100;
            border-bottom: var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .global-search-box {
            position: relative; flex: 1; margin: 0 15px;
        }
        .global-search-box input {
            width: 100%; background: rgba(255,255,255,0.05); border: var(--glass-border);
            border-radius: 20px; padding: 10px 40px 10px 15px; color: white;
            transition: 0.3s;
        }
        .global-search-box input:focus { background: rgba(255,255,255,0.1); border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }
        .global-search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        /* --- CARDS & WIDGETS --- */
        .glass-card {
            background: var(--glass-surface); border: var(--glass-border);
            border-radius: 24px; padding: 20px; margin: 15px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }
        
        .pulse-indicator {
            width: 10px; height: 10px; border-radius: 50%; background: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green);
            animation: pulse 2s infinite; display: inline-block; margin-left: 5px;
        }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

        /* --- BALANCE HUD --- */
        .hud-display { text-align: center; padding: 25px 0; background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent); }
        .hud-value { font-size: 42px; font-weight: 800; background: linear-gradient(to bottom, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* --- CONTEXT GRID (The Brain) --- */
        .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .action-btn {
            background: rgba(255,255,255,0.03); border-radius: 16px; padding: 12px 5px;
            text-align: center; cursor: pointer; border: 1px solid transparent; transition: 0.2s;
        }
        .action-btn:active { background: rgba(255,255,255,0.1); transform: scale(0.95); }
        .action-icon { font-size: 20px; margin-bottom: 5px; display: block; }

        /* --- TABS --- */
        .tab-view { display: none; animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .tab-view.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- STUDENT LIST --- */
        .student-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: rgba(0,0,0,0.2); border-radius: 16px; margin-bottom: 8px; border-left: 3px solid transparent;
        }
        .student-row.debtor { border-left-color: var(--neon-red); }
        .student-row.paid { border-left-color: var(--neon-green); }

        /* --- FLOATING DOCK (Navigation) --- */
        .dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: rgba(10, 10, 15, 0.9); backdrop-filter: blur(20px);
            border: var(--glass-border); border-radius: 25px;
            display: flex; justify-content: space-evenly; padding: 15px 0;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6); z-index: 200;
        }
        .dock-item { position: relative; color: var(--text-muted); font-size: 20px; transition: 0.3s; cursor: pointer; }
        .dock-item.active { color: var(--neon-blue); transform: translateY(-5px); }
        .dock-item.active::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; background: var(--neon-blue); border-radius: 50%;
        }

        /* --- THE ORB (FAB) --- */
        .orb-fab {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.4);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white; cursor: pointer; transition: 0.3s;
        }
        .orb-fab:hover { box-shadow: 0 0 30px rgba(189, 0, 255, 0.6); transform: translateX(-50%) scale(1.1); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            z-index: 1000; display: none; justify-content: center; align-items: flex-end;
        }
        .modal-sheet {
            background: #111; width: 100%; max-width: 500px;
            border-radius: 30px 30px 0 0; padding: 30px;
            border-top: 1px solid #333; max-height: 85vh; overflow-y: auto;
            animation: sheetUp 0.3s ease-out;
        }
        @keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* INPUTS */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 5px; }
        input, select, textarea {
            width: 100%; background: #222; border: 1px solid #333; color: white;
            padding: 14px; border-radius: 12px; font-family: 'Cairo';
        }
        .btn-neon {
            width: 100%; padding: 15px; border-radius: 12px; border: none;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            color: white; font-weight: bold; font-size: 16px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 242, 255, 0.2);
        }

        /* LOCK SCREEN */
        #secure-gate {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="secure-gate">
        <div style="font-size: 50px; margin-bottom: 20px; filter: drop-shadow(0 0 10px var(--neon-blue));">ğŸ›¡ï¸</div>
        <h2 style="margin: 0; letter-spacing: 2px;">TRACKY INFINITY</h2>
        <p style="opacity: 0.5; font-size: 12px; margin-bottom: 30px;">System Locked</p>
        <div style="display: flex; gap: 15px; margin-bottom: 30px;">
            <div class="pin-entry" style="width:12px; height:12px; border-radius:50%; border:1px solid #555;"></div>
            <div class="pin-entry" style="width:12px; height:12px; border-radius:50%; border:1px solid #555;"></div>
            <div class="pin-entry" style="width:12px; height:12px; border-radius:50%; border:1px solid #555;"></div>
            <div class="pin-entry" style="width:12px; height:12px; border-radius:50%; border:1px solid #555;"></div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 70px); gap: 15px;">
            <button onclick="inputPin(1)" class="btn-neon" style="background:#111; border:1px solid #333;">1</button>
            <button onclick="inputPin(2)" class="btn-neon" style="background:#111; border:1px solid #333;">2</button>
            <button onclick="inputPin(3)" class="btn-neon" style="background:#111; border:1px solid #333;">3</button>
            <button onclick="inputPin(4)" class="btn-neon" style="background:#111; border:1px solid #333;">4</button>
            <button onclick="inputPin(5)" class="btn-neon" style="background:#111; border:1px solid #333;">5</button>
            <button onclick="inputPin(6)" class="btn-neon" style="background:#111; border:1px solid #333;">6</button>
            <button onclick="inputPin(7)" class="btn-neon" style="background:#111; border:1px solid #333;">7</button>
            <button onclick="inputPin(8)" class="btn-neon" style="background:#111; border:1px solid #333;">8</button>
            <button onclick="inputPin(9)" class="btn-neon" style="background:#111; border:1px solid #333;">9</button>
            <div></div>
            <button onclick="inputPin(0)" class="btn-neon" style="background:#111; border:1px solid #333;">0</button>
            <button onclick="resetPin()" class="btn-neon" style="background:transparent; color:var(--neon-red); border:none;">âœ•</button>
        </div>
    </div>

    <div id="infinity-app" style="display:none;">
        
        <div class="infinity-header">
            <div style="font-weight: 800; font-size: 18px; color: var(--neon-blue);">T. INFINITY</div>
            <div class="global-search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="global-search" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø´ÙŠØ¡..." onkeyup="globalSearch(this.value)">
            </div>
            <div style="display:flex; gap: 15px;">
                <i class="fas fa-eye" onclick="togglePrivacy()" style="cursor: pointer;"></i>
                <i class="fas fa-save" onclick="exportDB()" style="cursor: pointer; color: var(--neon-green);"></i>
            </div>
        </div>

        <div id="view-dash" class="tab-view active">
            <div class="glass-card hud-display">
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">
                    Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© <span class="pulse-indicator"></span>
                </div>
                <div id="main-balance" class="hud-value blur-sensitive">0</div>
                <div style="font-size: 11px; opacity: 0.6; margin-top: 5px;">ØµØ§ÙÙŠ Ø§Ù„Ø«Ø±ÙˆØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©</div>
            </div>

            <div id="ai-insight-box" class="glass-card" style="border-right: 3px solid var(--neon-purple); display: none;">
                <h4 style="margin:0; font-size: 14px; color: var(--neon-purple);">âš¡ ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ</h4>
                <p id="ai-text" style="font-size: 12px; margin: 5px 0; color: #ddd;"></p>
            </div>

            <div style="padding: 0 15px;">
                <h4 style="margin-bottom: 10px;">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="glass-card" style="margin:0; padding: 15px; text-align: center;">
                        <i class="fas fa-user-graduate" style="color: var(--neon-blue); font-size: 20px;"></i>
                        <div style="font-size: 10px; margin-top: 5px; color: #888;">Ø¯ÙŠÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                        <div id="dash-uni-debt" class="blur-sensitive" style="font-weight: bold; color: var(--neon-red);">0</div>
                    </div>
                    <div class="glass-card" style="margin:0; padding: 15px; text-align: center;">
                        <i class="fas fa-pills" style="color: var(--neon-green); font-size: 20px;"></i>
                        <div style="font-size: 10px; margin-top: 5px; color: #888;">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</div>
                        <div id="dash-clinic-sales" class="blur-sensitive" style="font-weight: bold; color: var(--text-main);">0</div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                    <span style="font-weight:bold; font-size:14px;">Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
                    <span style="font-size:10px; color:var(--neon-blue);">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</span>
                </div>
                <div id="dash-history"></div>
            </div>
        </div>

        <div id="view-uni" class="tab-view">
            <div style="padding: 15px;">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin:0">ğŸ“ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</h2>
                    <button onclick="openModal('modal-uni-settings')" style="background:#222; border:1px solid #444; color:white; border-radius:8px; padding:5px 10px; font-size:12px;">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                </div>

                <div style="display:flex; gap: 10px; margin-bottom: 15px;">
                    <button class="action-btn" style="flex:1; background:var(--neon-blue); color:#000; font-weight:bold;" onclick="openModal('modal-student-add')">+ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                    <button class="action-btn" style="flex:1;" onclick="openTransModal('expense', 'uni_ops')">Ù…ØµØ±ÙˆÙ ØªØ´ØºÙŠÙ„</button>
                </div>

                <div id="students-container"></div>
            </div>
        </div>

        <div id="view-clinic" class="tab-view">
            <div style="padding: 15px;">
                <h2 style="margin:0 0 15px 0;">ğŸ¥ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ù…Ø®Ø²Ù†</h2>
                
                <div class="action-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="action-btn" onclick="openTransModal('income', 'clinic_center', 'ÙƒØ´Ù Ù…Ø±ÙƒØ²')">
                        <i class="fas fa-hospital action-icon" style="color: var(--neon-blue);"></i> Ù…Ø±ÙƒØ²
                    </div>
                    <div class="action-btn" onclick="openTransModal('income', 'clinic_private', 'ÙƒØ´Ù Ø®Ø§Øµ')">
                        <i class="fas fa-user-md action-icon" style="color: var(--neon-purple);"></i> Ø®Ø§Øµ
                    </div>
                    <div class="action-btn" onclick="openModal('modal-drug-sell')">
                        <i class="fas fa-capsules action-icon" style="color: var(--neon-green);"></i> Ø¨ÙŠØ¹ Ø¯ÙˆØ§Ø¡
                    </div>
                </div>

                <div class="glass-card">
                    <h4>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ù…Ùˆ</h4>
                    <canvas id="clinicChart" height="150"></canvas>
                </div>

                <div class="glass-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4>ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</h4>
                        <button style="font-size:10px; padding:4px;" onclick="openModal('modal-drug-add')">+ ØµÙ†Ù</button>
                    </div>
                    <div id="inventory-list"></div>
                </div>
            </div>
        </div>

        <div id="view-life" class="tab-view">
            <div style="padding: 15px;">
                <h2 style="margin:0 0 15px 0;">ğŸ  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙŠØ§Ø©</h2>

                <div class="glass-card" style="background: linear-gradient(135deg, #1a1a2e, #16213e);">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:bold; font-size:16px;">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
                            <div style="font-size:10px; opacity:0.7" id="car-status-text">Ø­Ø§Ù„Ø© Ø§Ù„Ø²ÙŠØª Ù…Ù…ØªØ§Ø²Ø©</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:24px; font-weight:bold; color:var(--neon-blue);" id="car-km-left">0</div>
                            <div style="font-size:9px;">ÙƒÙ… Ù…ØªØ¨Ù‚ÙŠ</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                        <div id="car-bar" style="width: 100%; height: 100%; background: var(--neon-blue); border-radius: 3px; transition: width 0.5s;"></div>
                    </div>
                    <div style="margin-top: 15px; display:flex; gap:10px;">
                        <button class="action-btn" style="flex:1; font-size:11px;" onclick="openModal('modal-car-oil')">ØºÙŠÙ‘Ø±Øª Ø²ÙŠØª</button>
                        <button class="action-btn" style="flex:1; font-size:11px;" onclick="openTransModal('expense', 'car_gas', 'Ø¨Ù†Ø²ÙŠÙ†')">Ø¨Ù†Ø²ÙŠÙ†</button>
                    </div>
                </div>

                <div class="action-grid">
                    <div class="action-btn" onclick="openTransModal('expense', 'market', 'Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª')">
                        <i class="fas fa-shopping-cart action-icon" style="color:var(--neon-green)"></i> Ù…Ø§Ø±ÙƒØª
                    </div>
                    <div class="action-btn" onclick="openTransModal('expense', 'family', 'Ù…ØµØ§Ø±ÙŠÙ Ø¹Ø§Ø¦Ù„Ø©')">
                        <i class="fas fa-users action-icon" style="color:var(--neon-purple)"></i> Ø¹Ø§Ø¦Ù„Ø©
                    </div>
                    <div class="action-btn" onclick="openTransModal('expense', 'bills', 'ÙÙˆØ§ØªÙŠØ±')">
                        <i class="fas fa-file-invoice action-icon" style="color:var(--neon-red)"></i> ÙÙˆØ§ØªÙŠØ±
                    </div>
                    <div class="action-btn" onclick="openTransModal('income', 'bike', 'Ø¥ÙŠØ¬Ø§Ø± Ø¯Ø±Ø§Ø¬Ø©')">
                        <i class="fas fa-motorcycle action-icon" style="color:#fff"></i> Ø¯Ø±Ø§Ø¬Ø©
                    </div>
                </div>

                <div class="glass-card">
                    <h4>ğŸ”„ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ£Ù‚Ø³Ø§Ø·</h4>
                    <div id="subs-list"></div>
                    <button class="btn-neon" style="margin-top:10px; font-size:12px; padding:10px;" onclick="openModal('modal-sub-add')">+ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯</button>
                </div>
            </div>
        </div>

        <div id="search-overlay" class="tab-view" style="padding: 15px;">
            <h3>ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
            <div id="search-results"></div>
            <button class="btn-neon" style="background:#333; margin-top:20px;" onclick="closeSearch()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø«</button>
        </div>

    </div>

    <div class="dock" id="nav-dock" style="display:none;">
        <div class="dock-item active" onclick="navTo('view-dash', this)"><i class="fas fa-compass"></i></div>
        <div class="dock-item" onclick="navTo('view-uni', this)"><i class="fas fa-graduation-cap"></i></div>
        <div class="orb-fab" onclick="openContextGrid()"><i class="fas fa-plus"></i></div>
        <div class="dock-item" onclick="navTo('view-clinic', this)"><i class="fas fa-heartbeat"></i></div>
        <div class="dock-item" onclick="navTo('view-life', this)"><i class="fas fa-cube"></i></div>
    </div>

    <div class="modal-overlay" id="modal-context">
        <div class="modal-sheet">
            <h3 style="text-align:center; margin-bottom:20px;">Ù†Ù‚Ø·Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h3>
            <div class="action-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="action-btn" onclick="openTransModal('expense', 'personal', 'Ù…ØµØ±ÙˆÙ Ø´Ø®ØµÙŠ')">ğŸ‘¤ Ø´Ø®ØµÙŠ</div>
                <div class="action-btn" onclick="openTransModal('income', 'other', 'Ø¥ÙŠØ±Ø§Ø¯ Ø¥Ø¶Ø§ÙÙŠ')">ğŸ’° Ø¥ÙŠØ±Ø§Ø¯</div>
                <div class="action-btn" onclick="openModal('modal-debt-add')">ğŸ“’ Ø¯ÙŠÙ†/Ø³Ù„Ù</div>
                <div class="action-btn" onclick="openModal('modal-ai-scan')">ğŸ“¸ Ù…Ø³Ø­ ÙØ§ØªÙˆØ±Ø©</div>
                <div class="action-btn" onclick="openModal('modal-note')">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©</div>
            </div>
            <button class="btn-neon" style="background:transparent; margin-top:20px; color:#666;" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-trans">
        <div class="modal-sheet">
            <h3 id="tr-title">Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <div class="input-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="tr-amount" style="font-size:20px; color:var(--neon-green);">
            </div>
            <div class="input-group">
                <label>Ø§Ù„ÙˆØµÙ / Ø§Ù„Ø¨Ù†Ø¯</label>
                <input type="text" id="tr-item" list="items-history" oninput="predictCategory()">
                <datalist id="items-history"></datalist>
            </div>
            <div id="ai-prediction" style="font-size:11px; color:var(--neon-purple); margin-bottom:10px; display:none;">ğŸ¤– ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù‡Ø°Ø§ "Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª"ØŸ</div>
            
            <input type="hidden" id="tr-type">
            <input type="hidden" id="tr-cat">
            <button class="btn-neon" onclick="submitTransaction()">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-student-add">
        <div class="modal-sheet">
            <h3>Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
            <input type="text" id="st-name" placeholder="Ø§Ù„Ø§Ø³Ù…" class="input-group">
            <input type="tel" id="st-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" class="input-group">
            <div style="display:flex; gap:10px;" class="input-group">
                <select id="st-year"><option value="1">ÙØ±Ù‚Ø© 1</option><option value="2">ÙØ±Ù‚Ø© 2</option><option value="3">ÙØ±Ù‚Ø© 3</option><option value="4">ÙØ±Ù‚Ø© 4</option></select>
                <input type="number" id="st-subs" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯">
            </div>
            <button class="btn-neon" onclick="submitStudent()">ØªØ³Ø¬ÙŠÙ„</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-student-detail">
        <div class="modal-sheet">
            <h3 id="std-name-display">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
            <div class="glass-card" style="margin:0 0 15px 0; text-align:center;">
                <div style="font-size:10px; color:#888">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„ÙŠÙ‡</div>
                <div id="std-debt-display" style="font-size:24px; font-weight:bold; color:var(--neon-red)">0</div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <a id="std-call-btn" href="#" class="action-btn" style="flex:1"><i class="fas fa-phone"></i> Ø§ØªØµØ§Ù„</a>
                <a id="std-wa-btn" href="#" class="action-btn" style="flex:1; color:#25D366"><i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨</a>
            </div>
            <div class="input-group">
                <label>ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</label>
                <input type="number" id="std-pay-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            </div>
            <input type="hidden" id="std-id-target">
            <button class="btn-neon" onclick="submitStudentPay()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</button>
            <button class="btn-neon" style="background:#333; margin-top:10px;" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-drug-add">
        <div class="modal-sheet">
            <h3>ØµÙ†Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø®Ø²Ù†</h3>
            <input type="text" id="d-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡" class="input-group">
            <div style="display:flex; gap:10px;" class="input-group">
                <input type="number" id="d-cost" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
                <input type="number" id="d-price" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
            </div>
            <input type="number" id="d-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" class="input-group">
            <div id="d-margin" style="font-size:11px; color:var(--neon-green); margin-bottom:10px;"></div>
            <button class="btn-neon" onclick="submitDrug()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
    </div>

    <script>
        // === CORE SYSTEM ===
        const DB_KEY = 'tracky_infinity_v8';
        let db = {
            trans: [],
            students: [],
            inventory: [],
            subs: [],
            car: { km: 0, last_oil: 0, limit: 5000 },
            uni_settings: { sub_price: 250, plat_price: 100 },
            pin: '0000'
        };

        // --- SECURITY LAYER ---
        let pinBuffer = "";
        function inputPin(n) {
            pinBuffer += n;
            updatePinUI();
            if(pinBuffer.length === 4) {
                if(pinBuffer === db.pin) unlockSystem();
                else { alert('Access Denied'); resetPin(); }
            }
        }
        function resetPin() { pinBuffer = ""; updatePinUI(); }
        function updatePinUI() {
            document.querySelectorAll('.pin-entry').forEach((el, i) => {
                el.style.background = i < pinBuffer.length ? 'var(--neon-blue)' : 'transparent';
            });
        }
        function unlockSystem() {
            document.getElementById('secure-gate').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('secure-gate').style.display = 'none';
                document.getElementById('infinity-app').style.display = 'block';
                document.getElementById('nav-dock').style.display = 'flex';
                loadData();
                initView();
            }, 500);
        }

        // --- DATA MANAGEMENT ---
        function loadData() {
            const raw = localStorage.getItem(DB_KEY);
            if(raw) db = JSON.parse(raw);
            renderDashboard();
        }
        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            renderDashboard(); // Auto refresh
        }

        // --- NAVIGATION ---
        function navTo(viewId, el) {
            document.querySelectorAll('.tab-view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            document.querySelectorAll('.dock-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');

            if(viewId === 'view-uni') renderStudents();
            if(viewId === 'view-clinic') renderInventory();
            if(viewId === 'view-life') renderLife();
        }

        // --- DASHBOARD LOGIC ---
        function renderDashboard() {
            // 1. Calc Balance
            let bal = 0;
            db.trans.forEach(t => t.type === 'income' ? bal += parseFloat(t.amount) : bal -= parseFloat(t.amount));
            document.getElementById('main-balance').innerText = bal.toLocaleString();

            // 2. Calc Summaries
            let uniDebt = 0;
            db.students.forEach(s => uniDebt += (s.total_due - s.paid));
            document.getElementById('dash-uni-debt').innerText = uniDebt.toLocaleString();

            // 3. History
            const hist = document.getElementById('dash-history');
            hist.innerHTML = '';
            db.trans.slice(-5).reverse().forEach(t => {
                hist.innerHTML += `
                <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.05); font-size:12px;">
                    <span style="color:#ccc">${t.item || t.cat}</span>
                    <span style="color:${t.type==='income'?'var(--neon-green)':'var(--neon-red)'}">${t.amount}</span>
                </div>`;
            });
            
            // 4. Update AutoComplete
            const dl = document.getElementById('items-history');
            dl.innerHTML = '';
            [...new Set(db.trans.map(t=>t.item))].forEach(i => dl.innerHTML += `<option value="${i}">`);
        }

        // --- UNIVERSITY LOGIC ---
        function submitStudent() {
            const s = {
                id: Date.now(),
                name: document.getElementById('st-name').value,
                phone: document.getElementById('st-phone').value,
                year: document.getElementById('st-year').value,
                subs: parseInt(document.getElementById('st-subs').value),
                paid: 0,
                history: []
            };
            s.total_due = (s.subs * db.uni_settings.sub_price) + parseInt(db.uni_settings.plat_price);
            db.students.push(s);
            saveDB(); closeModal(); renderStudents();
        }

        function renderStudents() {
            const c = document.getElementById('students-container');
            c.innerHTML = '';
            db.students.forEach(s => {
                const debt = s.total_due - s.paid;
                c.innerHTML += `
                <div class="student-row ${debt>0?'debtor':'paid'}" onclick="openStudentDetail(${s.id})">
                    <div>
                        <div style="font-weight:bold; font-size:14px;">${s.name}</div>
                        <div style="font-size:10px; opacity:0.6">${s.phone} | ÙØ±Ù‚Ø© ${s.year}</div>
                    </div>
                    <div style="text-align:left;">
                        <div style="font-size:10px;">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</div>
                        <div style="font-weight:bold; color:${debt>0?'var(--neon-red)':'var(--neon-green)'}">${debt}</div>
                    </div>
                </div>`;
            });
        }

        function openStudentDetail(id) {
            const s = db.students.find(x => x.id === id);
            document.getElementById('std-name-display').innerText = s.name;
            document.getElementById('std-debt-display').innerText = (s.total_due - s.paid);
            document.getElementById('std-id-target').value = s.id;
            document.getElementById('std-call-btn').href = `tel:${s.phone}`;
            document.getElementById('std-wa-btn').href = `https://wa.me/2${s.phone}`;
            openModal('modal-student-detail');
        }

        function submitStudentPay() {
            const id = parseInt(document.getElementById('std-id-target').value);
            const amt = parseFloat(document.getElementById('std-pay-amount').value);
            const sIdx = db.students.findIndex(x => x.id === id);
            
            if(sIdx > -1 && amt) {
                db.students[sIdx].paid += amt;
                db.trans.push({
                    id: Date.now(), type: 'income', amount: amt, cat: 'uni_fees',
                    item: `Ù‚Ø³Ø·: ${db.students[sIdx].name}`, date: new Date().toLocaleDateString()
                });
                saveDB(); closeModal(); renderStudents();
            }
        }

        // --- INVENTORY LOGIC ---
        function submitDrug() {
            db.inventory.push({
                id: Date.now(),
                name: document.getElementById('d-name').value,
                cost: parseFloat(document.getElementById('d-cost').value),
                price: parseFloat(document.getElementById('d-price').value),
                qty: parseInt(document.getElementById('d-qty').value)
            });
            saveDB(); closeModal(); renderInventory();
        }

        function renderInventory() {
            const c = document.getElementById('inventory-list');
            c.innerHTML = '';
            db.inventory.forEach(d => {
                c.innerHTML += `
                <div class="list-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #333;">
                    <span>${d.name} (${d.qty})</span>
                    <span style="color:var(--neon-green)">${d.price} Ø¬.Ù…</span>
                </div>`;
            });
        }

        // --- LIFE / CAR LOGIC ---
        function renderLife() {
            const used = db.car.km - db.car.last_oil;
            const left = db.car.limit - used;
            const pct = Math.max(0, (left / db.car.limit) * 100);
            
            document.getElementById('car-bar').style.width = pct + '%';
            document.getElementById('car-km-left').innerText = left;
            document.getElementById('car-status-text').innerText = left < 500 ? "âš ï¸ ÙŠÙ„Ø²Ù… Ø§Ù„ØªØºÙŠÙŠØ± Ù‚Ø±ÙŠØ¨Ø§Ù‹" : "Ø­Ø§Ù„Ø© Ø§Ù„Ø²ÙŠØª Ù…Ù…ØªØ§Ø²Ø©";
            if(left < 500) document.getElementById('car-bar').style.background = 'var(--neon-red)';
        }

        // --- GENERIC TRANS ---
        function openTransModal(type, cat, placeholder) {
            closeModal();
            document.getElementById('tr-type').value = type;
            document.getElementById('tr-cat').value = cat;
            if(placeholder) document.getElementById('tr-item').placeholder = placeholder;
            document.getElementById('tr-title').innerText = type === 'income' ? 'ØªØ³Ø¬ÙŠÙ„ Ø¥ÙŠØ±Ø§Ø¯' : 'ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ';
            openModal('modal-trans');
        }

        function submitTransaction() {
            db.trans.push({
                id: Date.now(),
                type: document.getElementById('tr-type').value,
                cat: document.getElementById('tr-cat').value,
                amount: document.getElementById('tr-amount').value,
                item: document.getElementById('tr-item').value,
                date: new Date().toLocaleDateString()
            });
            saveDB(); closeModal();
        }

        // --- GLOBAL SEARCH (NEURAL) ---
        function globalSearch(q) {
            if(q.length < 2) { document.getElementById('search-overlay').classList.remove('active'); return; }
            
            document.getElementById('search-overlay').classList.add('active');
            const res = document.getElementById('search-results');
            res.innerHTML = '';

            // Search Students
            db.students.filter(s => s.name.includes(q)).forEach(s => {
                res.innerHTML += `<div class="glass-card" onclick="openStudentDetail(${s.id})">ğŸ“ ${s.name}</div>`;
            });

            // Search Inventory
            db.inventory.filter(d => d.name.includes(q)).forEach(d => {
                res.innerHTML += `<div class="glass-card">ğŸ’Š ${d.name} (${d.qty})</div>`;
            });

            // Search Trans
            db.trans.filter(t => t.item && t.item.includes(q)).forEach(t => {
                res.innerHTML += `<div class="glass-card" style="font-size:12px;">ğŸ“„ ${t.item} (${t.amount})</div>`;
            });
        }
        function closeSearch() { 
            document.getElementById('search-overlay').classList.remove('active'); 
            document.getElementById('global-search').value = '';
        }

        // --- UTILS ---
        function openContextGrid() { openModal('modal-context'); }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
        function togglePrivacy() { document.body.classList.toggle('privacy-mode'); }
        function exportDB() {
            const a = document.createElement("a");
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            a.download = "Tracky_Infinity_Backup.json";
            a.click();
        }
        function initView() { navTo('view-dash', document.querySelector('.dock-item')); }

        // Profit Margin Calc
        document.getElementById('d-price').addEventListener('input', function() {
            const cost = document.getElementById('d-cost').value;
            const price = this.value;
            if(cost && price) {
                const profit = price - cost;
                document.getElementById('d-margin').innerText = `Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${profit} Ø¬.Ù… (${Math.round((profit/cost)*100)}%)`;
            }
        });
    </script>
</body>
</html>
