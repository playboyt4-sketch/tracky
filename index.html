<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family ERP V4</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #0f172a; --surface: #1e293b; --primary: #3b82f6; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --text: #f8fafc; --text-sec: #94a3b8; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Cairo', sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 90px; }

        /* HEADER & LOCK */
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .pin-dots { display: flex; gap: 15px; margin-bottom: 30px; }
        .pin-dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid var(--text-sec); }
        .pin-dot.filled { background: var(--primary); border-color: var(--primary); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .num-btn { width: 65px; height: 65px; border-radius: 50%; background: var(--surface); color: white; font-size: 22px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; }

        .header { padding: 15px 20px; background: rgba(15, 23, 42, 0.95); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        
        /* CARDS */
        .card { background: var(--surface); border-radius: 16px; padding: 15px; margin: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .balance-card { text-align: center; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .total-amount { font-size: 34px; font-weight: 800; margin: 10px 0; }
        
        /* QUICK ACTIONS for WIFE */
        .quick-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px; }
        .quick-btn { background: var(--surface); border: 1px solid #334155; padding: 10px 5px; border-radius: 12px; text-align: center; font-size: 11px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .quick-btn i { font-size: 18px; color: var(--accent); }

        /* TRANSACTION LIST */
        .trans-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #334155; }
        .trans-info h4 { margin: 0; font-size: 14px; }
        .trans-info span { font-size: 11px; opacity: 0.6; }
        .trans-amount { font-weight: bold; font-size: 14px; }
        .del-btn { color: var(--danger); background: none; border: none; padding: 5px 10px; cursor: pointer; font-size: 12px; }

        /* TABS & NAV */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .nav { position: fixed; bottom: 0; width: 100%; background: #0f172a; padding: 10px 0; display: flex; justify-content: space-around; border-top: 1px solid #334155; z-index: 200; }
        .nav-item { text-align: center; font-size: 10px; opacity: 0.6; transition: 0.3s; }
        .nav-item.active { opacity: 1; color: var(--primary); transform: translateY(-3px); }
        .nav-icon { font-size: 20px; margin-bottom: 4px; display: block; }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal-box { background: var(--surface); width: 100%; max-width: 500px; padding: 25px; border-radius: 25px 25px 0 0; max-height: 90vh; overflow-y: auto; }
        
        input, select { width: 100%; padding: 14px; background: var(--bg); border: 1px solid #334155; color: white; border-radius: 12px; margin-bottom: 10px; font-family: 'Cairo'; outline: none; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        
        .fab { position: fixed; bottom: 85px; left: 20px; width: 55px; height: 55px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4); z-index: 190; cursor: pointer; }
        
        /* ADVICE BOX */
        .advice-box { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); padding: 10px; border-radius: 8px; font-size: 11px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h3>Tracky Secure ğŸ”’</h3>
        <p style="font-size:12px; opacity:0.6; margin-bottom:20px;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 0000)</p>
        <div class="pin-dots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <div class="numpad">
            <button class="num-btn" onclick="enterPin(1)">1</button>
            <button class="num-btn" onclick="enterPin(2)">2</button>
            <button class="num-btn" onclick="enterPin(3)">3</button>
            <button class="num-btn" onclick="enterPin(4)">4</button>
            <button class="num-btn" onclick="enterPin(5)">5</button>
            <button class="num-btn" onclick="enterPin(6)">6</button>
            <button class="num-btn" onclick="enterPin(7)">7</button>
            <button class="num-btn" onclick="enterPin(8)">8</button>
            <button class="num-btn" onclick="enterPin(9)">9</button>
            <button class="num-btn" style="visibility:hidden"></button>
            <button class="num-btn" onclick="enterPin(0)">0</button>
            <button class="num-btn" style="color:#ef4444" onclick="clearPin()">âŒ«</button>
        </div>
    </div>

    <div id="app-content" style="display:none">
        <div class="header">
            <div style="font-weight:800; font-size:18px;">Tracky ERP ğŸ’</div>
            <button onclick="exportData()" style="background:none; border:none; color:#f59e0b; font-size:18px;"><i class="fas fa-save"></i></button>
        </div>

        <div id="tab-home" class="tab-content active">
            <div class="card balance-card">
                <div style="font-size: 12px; opacity: 0.7;">ØµØ§ÙÙŠ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© (Ø¨Ø¯ÙˆÙ† Ø¯ÙŠÙˆÙ† Ø§Ù„ÙÙŠØ²Ø§)</div>
                <div class="total-amount" id="net-balance">0</div>
                <div style="display:flex; justify-content:center; gap:15px; font-size:11px;">
                    <span style="color:#ef4444">Ø¹Ù„ÙŠÙƒ Ù„Ù„ÙÙŠØ²Ø§: <span id="visa-debt">0</span></span>
                    <span style="color:#10b981">Ù„Ùƒ Ø¨Ø±Ø©: <span id="my-credits">0</span></span>
                </div>
            </div>

            <div class="quick-grid">
                <div class="quick-btn" onclick="quickAdd('Ø®Ø¶Ø§Ø±/ÙØ§ÙƒÙ‡Ø©', 0, 'groceries')"><i class="fas fa-carrot" style="color:#10b981"></i> Ø®Ø¶Ø§Ø±</div>
                <div class="quick-btn" onclick="quickAdd('Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª', 0, 'groceries')"><i class="fas fa-shopping-cart" style="color:#3b82f6"></i> Ù…Ø§Ø±ÙƒØª</div>
                <div class="quick-btn" onclick="quickAdd('ØµÙŠØ¯Ù„ÙŠØ©/Ø¯ÙˆØ§Ø¡', 0, 'family')"><i class="fas fa-pills" style="color:#ef4444"></i> Ø¯ÙˆØ§Ø¡</div>
                <div class="quick-btn" onclick="quickAdd('Ù…ÙˆØ§ØµÙ„Ø§Øª', 0, 'personal')"><i class="fas fa-taxi" style="color:#f59e0b"></i> ØªØ§ÙƒØ³ÙŠ</div>
            </div>

            <div class="card">
                <h4 style="margin:0 0 10px 0;">ğŸ“ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</h4>
                <div id="recent-history"></div>
            </div>
        </div>

        <div id="tab-analysis" class="tab-content">
            <h2 style="padding:0 15px;">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ</h2>
            <div class="card">
                <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³Ù„Ø¹Ø© (Ù†Ø³ÙƒØ§ÙÙŠÙ‡ØŒ Ø¨Ù†Ø²ÙŠÙ†)..." onkeyup="analyzeItem(this.value)">
                <div id="analysis-result" style="font-size:12px; margin-top:10px; opacity:0.7"></div>
            </div>
            
            <div class="card">
                <h3>ğŸ‘§ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h3>
                <h1 id="family-total" style="color:#ec4899">0</h1>
                <p style="font-size:11px; opacity:0.6">ÙŠØ´Ù…Ù„ Ø§Ù„Ø¯Ø±ÙˆØ³ØŒ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†ØŒ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</p>
            </div>
        </div>

        <div id="tab-services" class="tab-content">
            <div class="card">
                <div style="display:flex; justify-content:space-between;">
                    <h3>ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h3>
                    <button onclick="openModal('modal-oil')" style="background:#3b82f6; border:none; color:white; border-radius:5px; padding:5px 10px;">ØªØ³Ø¬ÙŠÙ„ ØµÙŠØ§Ù†Ø©</button>
                </div>
                <div id="car-info" style="font-size:12px; margin-top:10px;"></div>
            </div>

            <div class="card">
                <h3>ğŸ”„ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆÙÙˆØ§ØªÙŠØ±</h3>
                <div id="subs-alert-box"></div>
                <button onclick="openModal('modal-sub')" class="btn" style="background:#334155; margin-top:10px;">+ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>

        <div class="fab" onclick="openModal('modal-trans')">+</div>

        <div class="nav">
            <div class="nav-item active" onclick="switchTab('tab-home', this)"><i class="fas fa-home nav-icon"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
            <div class="nav-item" onclick="switchTab('tab-analysis', this)"><i class="fas fa-chart-pie nav-icon"></i> Ø§Ù„ØªØ­Ù„ÙŠÙ„</div>
            <div class="nav-item" onclick="switchTab('tab-services', this)"><i class="fas fa-car nav-icon"></i> Ø®Ø¯Ù…Ø§Øª</div>
        </div>
    </div>

    <div class="modal" id="modal-trans">
        <div class="modal-box">
            <h3>Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <select id="t-type" onchange="toggleFields()">
                <option value="expense">ğŸ’¸ Ù…ØµØ±ÙˆÙ</option>
                <option value="income">ğŸ’° Ø¥ÙŠØ±Ø§Ø¯</option>
            </select>
            
            <input type="number" id="t-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            
            <input type="text" id="t-item" list="items-list" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯ (Ø§Ø¨Ø­Ø« Ù‡Ù†Ø§...)" oninput="checkAdvice()">
            <datalist id="items-list"></datalist> <div id="smart-advice" class="advice-box"></div>

            <select id="t-method">
                <option value="cash">ğŸ’µ ÙƒØ§Ø´ (Ø®Ø²ÙŠÙ†Ø©)</option>
                <option value="visa">ğŸ’³ ÙÙŠØ²Ø§ (Ø¢Ø¬Ù„/Ø¯ÙŠÙ†)</option>
            </select>

            <select id="t-cat" style="display:block">
                <option value="groceries">ğŸ›’ Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>
                <option value="family">ğŸ‘§ Ø¹Ø§Ø¦Ù„Ø© ÙˆØ¯Ø±ÙˆØ³</option>
                <option value="car">ğŸš— Ø³ÙŠØ§Ø±Ø©</option>
                <option value="personal">ğŸ‘” Ø´Ø®ØµÙŠ</option>
                <option value="bills">ğŸ’¡ ÙÙˆØ§ØªÙŠØ±</option>
            </select>

            <input type="text" id="t-vendor" placeholder="Ø§Ù„Ù…ÙƒØ§Ù† (ÙƒØ§Ø±ÙÙˆØ±ØŒ ÙƒØ´Ùƒ..)">

            <button class="btn btn-primary" onclick="saveTrans()">Ø­ÙØ¸</button>
            <button class="btn" style="background:transparent; color:#94a3b8" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="modal" id="modal-oil">
        <div class="modal-box">
            <h3>ØµÙŠØ§Ù†Ø© Ø³ÙŠØ§Ø±Ø© ğŸ”§</h3>
            <input type="number" id="o-km" placeholder="Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±">
            <input type="text" id="o-note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø²ÙŠØªØŒ ÙÙ„Ø§ØªØ±..)">
            <input type="number" id="o-cost" placeholder="Ø§Ù„ØªÙƒÙ„ÙØ©">
            <button class="btn btn-primary" onclick="saveOil()">Ø­ÙØ¸</button>
            <button class="btn" style="background:transparent" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="modal" id="modal-sub">
        <div class="modal-box">
            <h3>Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯ ğŸ”„</h3>
            <input type="text" id="s-name" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù†ØªØŒ Ø¬ÙŠÙ…..)">
            <input type="number" id="s-cost" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©">
            <input type="number" id="s-day" placeholder="ÙŠÙˆÙ… Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (1-30)">
            <button class="btn btn-primary" onclick="saveSub()">Ø­ÙØ¸</button>
            <button class="btn" style="background:transparent" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        // DATA
        let db = {
            trans: JSON.parse(localStorage.getItem('erp_v4_trans')) || [],
            subs: JSON.parse(localStorage.getItem('erp_v4_subs')) || [],
            car: JSON.parse(localStorage.getItem('erp_v4_car')) || [],
            pin: localStorage.getItem('erp_v4_pin') || '0000'
        };

        // --- 1. SECURITY ---
        let enteredPin = '';
        function enterPin(n) {
            if(enteredPin.length < 4) {
                enteredPin += n;
                updateDots();
                if(enteredPin.length === 4) checkPin();
            }
        }
        function clearPin() { enteredPin = ''; updateDots(); }
        function updateDots() {
            document.querySelectorAll('.pin-dot').forEach((d,i) => d.classList.toggle('filled', i < enteredPin.length));
        }
        function checkPin() {
            if(enteredPin === db.pin) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                initApp();
            } else {
                alert('Ø§Ù„Ø±Ù…Ø² Ø®Ø·Ø£'); enteredPin = ''; updateDots();
            }
        }

        // --- 2. CORE FUNCTIONS ---
        function initApp() {
            renderBalance();
            renderHistory();
            populateAutoComplete();
            renderCar();
            renderSubs();
        }

        function renderBalance() {
            let liquid = 0;
            let visaDebt = 0;
            let family = 0;

            db.trans.forEach(t => {
                if(t.type === 'income') liquid += parseFloat(t.amount);
                else {
                    if(t.method === 'visa') visaDebt += parseFloat(t.amount); // Visa doesn't reduce cash now
                    else liquid -= parseFloat(t.amount); // Cash reduces cash

                    if(t.cat === 'family') family += parseFloat(t.amount);
                }
            });

            document.getElementById('net-balance').innerText = liquid.toLocaleString() + ' Ø¬.Ù…';
            document.getElementById('visa-debt').innerText = visaDebt.toLocaleString();
            document.getElementById('family-total').innerText = family.toLocaleString() + ' Ø¬.Ù…';
        }

        function renderHistory() {
            const list = document.getElementById('recent-history');
            list.innerHTML = '';
            // Show last 20
            db.trans.slice(0, 20).forEach((t, index) => {
                list.innerHTML += `
                <div class="trans-item">
                    <div class="trans-info">
                        <h4>${t.item || t.cat} <span style="font-size:10px; background:#333; padding:2px 5px; border-radius:4px;">${t.method === 'visa' ? 'ÙÙŠØ²Ø§' : 'ÙƒØ§Ø´'}</span></h4>
                        <span>${t.date} | ${t.vendor || '-'}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="trans-amount" style="color:${t.type==='income'?'#10b981':'#ef4444'}">
                            ${t.amount}
                        </span>
                        <button class="del-btn" onclick="deleteTrans(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
        }

        function deleteTrans(index) {
            if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØªØµØ­ÙŠØ­ Ø§Ù„Ø±ØµÙŠØ¯ØŸ')) {
                db.trans.splice(index, 1);
                saveAll();
                initApp();
            }
        }

        // --- 3. SMART FEATURES ---
        function populateAutoComplete() {
            // Get unique items names
            const items = [...new Set(db.trans.map(t => t.item))];
            const datalist = document.getElementById('items-list');
            datalist.innerHTML = '';
            items.forEach(i => {
                if(i) datalist.innerHTML += `<option value="${i}">`;
            });
        }

        function checkAdvice() {
            const input = document.getElementById('t-item').value;
            if(input.length < 3) return;
            
            // Case insensitive search
            const history = db.trans.filter(t => t.item && t.item.toLowerCase() === input.toLowerCase());
            if(history.length > 0) {
                history.sort((a,b) => parseFloat(a.amount) - parseFloat(b.amount));
                const best = history[0];
                document.getElementById('smart-advice').style.display = 'block';
                document.getElementById('smart-advice').innerHTML = `ğŸ’¡ Ø§Ø´ØªØ±ÙŠØªÙ‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ø¨Ù€ <b>${best.amount}</b> Ù…Ù† <b>${best.vendor}</b>`;
            } else {
                document.getElementById('smart-advice').style.display = 'none';
            }
        }

        function quickAdd(item, amount, cat) {
            document.getElementById('t-item').value = item;
            document.getElementById('t-cat').value = cat;
            document.getElementById('t-amount').value = amount || '';
            openModal('modal-trans');
            if(amount === 0) document.getElementById('t-amount').focus();
        }

        // --- 4. DATA SAVING ---
        function saveTrans() {
            const trans = {
                id: Date.now(),
                type: document.getElementById('t-type').value,
                amount: document.getElementById('t-amount').value,
                item: document.getElementById('t-item').value,
                cat: document.getElementById('t-cat').value,
                method: document.getElementById('t-method').value,
                vendor: document.getElementById('t-vendor').value,
                date: new Date().toLocaleDateString('en-GB')
            };

            if(!trans.amount) return;

            db.trans.unshift(trans);
            saveAll();
            closeModal();
            initApp();
            
            // Reset inputs
            document.getElementById('t-amount').value = '';
            document.getElementById('t-item').value = '';
            document.getElementById('t-vendor').value = '';
        }

        function saveOil() {
            db.car.push({
                km: document.getElementById('o-km').value,
                note: document.getElementById('o-note').value,
                date: new Date().toLocaleDateString('en-GB')
            });
            const cost = document.getElementById('o-cost').value;
            if(cost > 0) { // Add cost to expenses automatically
                db.trans.unshift({
                    id: Date.now(), type: 'expense', amount: cost, item: 'ØµÙŠØ§Ù†Ø© Ø³ÙŠØ§Ø±Ø©', cat: 'car', method: 'cash', date: new Date().toLocaleDateString()
                });
            }
            saveAll(); closeModal(); initApp();
        }

        function saveSub() {
            db.subs.push({
                name: document.getElementById('s-name').value,
                cost: document.getElementById('s-cost').value,
                day: document.getElementById('s-day').value
            });
            saveAll(); closeModal(); initApp();
        }

        function renderCar() {
            const last = db.car[db.car.length-1];
            const div = document.getElementById('car-info');
            if(last) div.innerHTML = `Ø¢Ø®Ø± ØµÙŠØ§Ù†Ø©: <b>${last.date}</b> | Ø¹Ø¯Ø§Ø¯: <b>${last.km} ÙƒÙ…</b> <br> (${last.note})`;
            else div.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØµÙŠØ§Ù†Ø©";
        }

        function renderSubs() {
            const today = new Date().getDate();
            const box = document.getElementById('subs-alert-box');
            box.innerHTML = '';
            db.subs.forEach(s => {
                const diff = s.day - today;
                let color = '#94a3b8';
                let msg = `ÙŠÙˆÙ… ${s.day}`;
                if(diff >= 0 && diff <= 3) { color = '#ef4444'; msg = 'Ù…Ø³ØªØ­Ù‚ Ù‚Ø±ÙŠØ¨Ø§Ù‹!'; }
                
                box.innerHTML += `
                <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #333;">
                    <span>${s.name} (${s.cost})</span>
                    <span style="color:${color}; font-size:11px;">${msg}</span>
                </div>`;
            });
        }

        function saveAll() {
            localStorage.setItem('erp_v4_trans', JSON.stringify(db.trans));
            localStorage.setItem('erp_v4_subs', JSON.stringify(db.subs));
            localStorage.setItem('erp_v4_car', JSON.stringify(db.car));
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "backup_erp.json");
            node.click();
        }

        // UTILS
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function switchTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
        function toggleFields() {
             // Logic to hide/show fields based on income/expense if needed
        }
        function analyzeItem(val) {
            // Simple filter logic for analysis tab
            if(val.length < 2) return;
            const res = db.trans.filter(t => t.item && t.item.includes(val));
            let total = res.reduce((a,b)=>a+parseFloat(b.amount), 0);
            document.getElementById('analysis-result').innerHTML = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¹Ù„Ù‰ "${val}": <b style="color:white">${total} Ø¬.Ù…</b> (Ø¹Ø¯Ø¯ ${res.length} Ù…Ø±Ø§Øª)`;
        }
    </script>
</body>
</html>
