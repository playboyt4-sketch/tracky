<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family ERP</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --primary: #3b82f6;
            --accent: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text: #f8fafc;
            --text-sec: #94a3b8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding-bottom: 80px; /* Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
            overscroll-behavior-y: none;
        }

        /* --- HEADER --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .action-buttons { display: flex; gap: 10px; }
        
        .btn-icon {
            width: 40px; height: 40px;
            border-radius: 12px;
            border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-add-money { background: var(--success); color: #fff; }
        .btn-add-expense { background: var(--danger); color: #fff; }
        .btn-add-event { background: var(--warning); color: #fff; }

        /* --- BALANCE CARD --- */
        .balance-container {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--surface) 0%, #0f172a 100%);
            margin: 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }
        
        .total-label { font-size: 14px; color: var(--text-sec); margin-bottom: 5px; }
        .total-amount { font-size: 36px; font-weight: 800; letter-spacing: 1px; }
        .eye-toggle { position: absolute; top: 15px; left: 15px; color: var(--text-sec); cursor: pointer; padding: 10px;}

        /* --- ANALYSIS CHART --- */
        .chart-card {
            margin: 0 15px 20px 15px;
            padding: 15px;
            background: var(--surface);
            border-radius: 16px;
        }

        /* --- ALERTS & TODOS --- */
        .section-title { padding: 0 20px; font-size: 18px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .section-title span { font-size: 12px; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; font-weight: normal; cursor: pointer;}

        .alerts-scroll {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 15px 20px;
            padding-bottom: 5px; /* scrollbar hide */
        }
        .alerts-scroll::-webkit-scrollbar { display: none; }

        .alert-card {
            min-width: 200px;
            padding: 15px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .alert-financial { background: linear-gradient(135deg, #451a1a 0%, #7f1d1d 100%); border: 1px solid #ef4444; }
        .alert-event { background: linear-gradient(135deg, #1e3a8a 0%, #172554 100%); border: 1px solid #3b82f6; }
        
        .alert-title { font-weight: 700; font-size: 14px; margin-bottom: 5px; }
        .alert-date { font-size: 11px; opacity: 0.8; margin-bottom: 10px; }
        .alert-action { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px; border-radius: 8px; font-size: 12px; cursor: pointer; }

        /* --- LISTS (Income/Expense/Profit) --- */
        .list-container { padding: 0 15px; display: none; } /* Hidden by default */
        .list-container.active { display: block; animation: fadeIn 0.3s; }
        
        .list-item {
            background: var(--surface);
            padding: 15px;
            border-radius: 14px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid transparent;
        }
        .item-details h4 { margin: 0; font-size: 15px; }
        .item-details p { margin: 5px 0 0 0; font-size: 11px; color: var(--text-sec); }
        .item-amount { font-weight: 700; font-size: 15px; }
        
        .source-clinic { border-left-color: var(--success); }
        .source-teaching { border-left-color: var(--accent); }
        .source-personal { border-left-color: var(--warning); }

        /* --- BOTTOM NAV --- */
        .nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            display: flex; justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid rgba(255,255,255,0.05);
            z-index: 200;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-sec); font-size: 10px; cursor: pointer; transition: 0.2s;
        }
        .nav-item i { font-size: 18px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }

        /* --- MODALS --- */
        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: flex-end;
        }
        .modal-content {
            background: #1e293b;
            width: 100%; max-width: 500px;
            border-radius: 25px 25px 0 0;
            padding: 25px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* INPUTS */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 12px; color: var(--text-sec); }
        input, select, textarea {
            width: 100%; padding: 14px;
            background: #0f172a; border: 1px solid #334155;
            color: white; border-radius: 12px;
            font-family: 'Cairo'; font-size: 14px;
            outline: none;
        }
        .btn-save { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 14px; font-weight: 700; margin-top: 10px; cursor: pointer; }
        .btn-close { background: transparent; color: var(--text-sec); margin-top: 10px; width: 100%; border: none; padding: 10px; cursor: pointer; }

        /* Payment Method Radio */
        .pay-methods { display: flex; gap: 10px; margin-top: 5px; }
        .pay-option { 
            flex: 1; padding: 10px; background: #0f172a; border: 1px solid #334155; 
            border-radius: 10px; text-align: center; font-size: 12px; cursor: pointer; 
        }
        .pay-option.selected { background: var(--primary); border-color: var(--primary); color: white; }

        /* Helper Classes */
        .d-none { display: none !important; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }

    </style>
</head>
<body>

    <div class="header">
        <div class="lang-switch" onclick="toggleLang()" style="font-size:12px; opacity:0.7">EN / AR</div>
        
        <div class="action-buttons">
            <button class="btn-icon btn-add-event" onclick="openModal('modal-event')"><i class="fas fa-bell"></i></button>
            <button class="btn-icon btn-add-expense" onclick="openModal('modal-trans', 'expense')"><i class="fas fa-minus"></i></button>
            <button class="btn-icon btn-add-money" onclick="openModal('modal-trans', 'income')"><i class="fas fa-plus"></i></button>
        </div>
    </div>

    <div id="tab-home" class="list-container active" style="padding-top: 10px;">
        
        <div class="balance-container">
            <div class="eye-toggle" onclick="toggleBalance()"><i class="fas fa-eye" id="eye-icon"></i></div>
            <div class="total-label" data-i18n="total_balance">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ</div>
            <div class="total-amount" id="main-balance">****</div>
            <div style="font-size: 11px; margin-top: 10px; opacity: 0.6; display:flex; justify-content:center; gap:15px;">
                <span><i class="fas fa-wallet"></i> <span id="cash-bal">0</span></span>
                <span><i class="fas fa-university"></i> <span id="bank-bal">0</span></span>
            </div>
        </div>

        <div class="chart-card">
            <h4 style="margin:0 0 10px 0; font-size:14px;" data-i18n="analysis">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©</h4>
            <canvas id="cashFlowChart" height="150"></canvas>
        </div>

        <div class="section-title">
            <span data-i18n="financial_alerts">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø§Ù„ÙŠØ©</span>
            <span onclick="openModal('modal-debts')">ğŸ“’ <span data-i18n="debts">Ø§Ù„Ø¯ÙŠÙˆÙ†</span></span>
        </div>
        <div class="alerts-scroll" id="financial-alerts-list">
            <div class="alert-card alert-financial">
                <div class="alert-title">Ù‚Ø³Ø· Ø³ÙŠØ§Ø±Ø©</div>
                <div class="alert-date">ÙŠØ³ØªØ­Ù‚ ØºØ¯Ø§Ù‹</div>
                <button class="alert-action">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>
            </div>
        </div>

        <div class="section-title" style="margin-top: 10px;">
            <span data-i18n="events">Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆÙ…Ù‡Ø§Ù…</span>
        </div>
        <div class="alerts-scroll" id="events-list">
            <div class="alert-card alert-event">
                <div class="alert-title">ØªÙ…Ø±ÙŠÙ† Ø§Ù„Ø³Ø¨Ø§Ø­Ø©</div>
                <div class="alert-date">Ø§Ù„ÙŠÙˆÙ… 6:00 Ù…</div>
                <button class="alert-action">ØªÙ…</button>
            </div>
        </div>
    </div>

    <div id="tab-income" class="list-container" style="padding-top: 20px;">
        <h2 data-i18n="income_details">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h2>
        <div id="income-list-render">
            </div>
    </div>

    <div id="tab-expense" class="list-container" style="padding-top: 20px;">
        <h2 data-i18n="expense_details">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
        <div id="expense-list-render">
            </div>
    </div>

    <div id="tab-analysis" class="list-container" style="padding-top: 20px;">
        <h2 data-i18n="profit_centers">Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø±Ø¨Ø­ÙŠØ©</h2>
        
        <div class="balance-container" style="text-align: right; background: linear-gradient(135deg, #059669 0%, #022c22 100%);">
            <div class="total-label">ğŸ¥ ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</div>
            <div class="total-amount" style="font-size: 24px;" id="clinic-profit">0</div>
            <div style="font-size: 11px; margin-top:5px;">Ø¥ÙŠØ±Ø§Ø¯: <span id="clinic-in">0</span> | Ù…ØµØ±ÙˆÙ: <span id="clinic-out">0</span></div>
        </div>

        <div class="balance-container" style="text-align: right; background: linear-gradient(135deg, #7c3aed 0%, #2e1065 100%);">
            <div class="total-label">ğŸ“ ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„ØªØ¯Ø±ÙŠØ³</div>
            <div class="total-amount" style="font-size: 24px;" id="teaching-profit">0</div>
            <div style="font-size: 11px; margin-top:5px;">Ø¥ÙŠØ±Ø§Ø¯: <span id="teaching-in">0</span> | Ù…ØµØ±ÙˆÙ: <span id="teaching-out">0</span></div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="switchTab('tab-home', this)">
            <i class="fas fa-home"></i> <span data-i18n="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </div>
        <div class="nav-item" onclick="switchTab('tab-income', this)">
            <i class="fas fa-arrow-down" style="color: var(--success)"></i> <span data-i18n="income">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span>
        </div>
        <div class="nav-item" onclick="switchTab('tab-expense', this)">
            <i class="fas fa-arrow-up" style="color: var(--danger)"></i> <span data-i18n="expenses">Ù…ØµØ±ÙˆÙØ§Øª</span>
        </div>
        <div class="nav-item" onclick="switchTab('tab-analysis', this)">
            <i class="fas fa-chart-pie"></i> <span data-i18n="reports">ØªØ­Ù„ÙŠÙ„</span>
        </div>
    </div>

    <div class="modal" id="modal-trans">
        <div class="modal-content">
            <h3 id="trans-title">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            
            <div class="form-group">
                <label data-i18n="amount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="t-amount" placeholder="0.00">
            </div>

            <div class="form-group">
                <label data-i18n="method">Ù…ÙƒØ§Ù† Ø§Ù„Ø­ÙØ¸ (Ø§Ù„Ø®Ø²ÙŠÙ†Ø©)</label>
                <div class="pay-methods">
                    <div class="pay-option selected" onclick="selectMethod(this, 'cash')" data-i18n="cash">Ù†Ù‚Ø¯ÙŠ</div>
                    <div class="pay-option" onclick="selectMethod(this, 'bank')" data-i18n="bank">Ø¨Ù†ÙƒÙŠ</div>
                    <div class="pay-option" onclick="selectMethod(this, 'wallet')" data-i18n="wallet">Ù…Ø­ÙØ¸Ø©</div>
                </div>
            </div>

            <div class="form-group">
                <label data-i18n="category">Ø§Ù„ØªØµÙ†ÙŠÙ / Ø§Ù„Ù…ØµØ¯Ø±</label>
                <select id="t-category">
                    </select>
            </div>
            
            <div class="form-group">
                <label data-i18n="desc">Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="text" id="t-desc" placeholder="Ù…Ø«Ø§Ù„: ÙØ§ØªÙˆØ±Ø© Ù†ØªØŒ Ù‚Ø³Ø·...">
            </div>

            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="t-is-debt" style="width:20px;">
                <label for="t-is-debt" style="margin:0; font-size:14px;">ØªØ³Ø¬ÙŠÙ„ ÙƒØ¯ÙŠÙ†/Ø³Ù„ÙØŸ</label>
            </div>

            <button class="btn-save" onclick="saveTransaction()" data-i18n="save">Ø­ÙØ¸</button>
            <button class="btn-close" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="modal" id="modal-event">
        <div class="modal-content">
            <h3>Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø¨ÙŠÙ‡ / Ù…ÙˆØ¹Ø¯</h3>
            <input type="text" id="e-title" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«">
            <input type="date" id="e-date">
            <input type="time" id="e-time">
            <div class="form-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</label>
                <select id="e-type">
                    <option value="event">Ù…ÙˆØ¹Ø¯ / Ù…Ù‡Ù…Ø© (Ø£Ø²Ø±Ù‚)</option>
                    <option value="financial">Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ù…Ø§Ù„ÙŠ (Ø£Ø­Ù…Ø±)</option>
                </select>
            </div>
            <button class="btn-save" onclick="saveEvent()">Ø­ÙØ¸ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
            <button class="btn-close" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        let transactions = JSON.parse(localStorage.getItem('erp_trans')) || [];
        let events = JSON.parse(localStorage.getItem('erp_events')) || [];
        let lang = localStorage.getItem('erp_lang') || 'ar';
        let showBalance = false;
        let currentMethod = 'cash';
        let currentType = 'expense'; // or income

        // --- DICTIONARY ---
        const dict = {
            ar: {
                total_balance: "Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ", analysis: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©", financial_alerts: "ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø§Ù„ÙŠØ©",
                debts: "Ø§Ù„Ø¯ÙŠÙˆÙ†", events: "Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆÙ…Ù‡Ø§Ù…", income_details: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª",
                expense_details: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª", profit_centers: "Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø±Ø¨Ø­ÙŠØ©",
                home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", income: "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", expenses: "Ù…ØµØ±ÙˆÙØ§Øª", reports: "ØªØ­Ù„ÙŠÙ„",
                amount: "Ø§Ù„Ù…Ø¨Ù„Øº", method: "Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹", category: "Ø§Ù„ØªØµÙ†ÙŠÙ", desc: "Ø§Ù„ÙˆØµÙ", save: "Ø­ÙØ¸",
                cash: "Ù†Ù‚Ø¯ÙŠ", bank: "Ø¨Ù†Ùƒ", wallet: "Ù…Ø­ÙØ¸Ø©"
            },
            en: {
                total_balance: "Total Balance", analysis: "Cash Flow", financial_alerts: "Financial Alerts",
                debts: "Debts", events: "Events & To-Do", income_details: "Income Details",
                expense_details: "Expense Details", profit_centers: "Profit Centers",
                home: "Home", income: "Income", expenses: "Expenses", reports: "Reports",
                amount: "Amount", method: "Method", category: "Category", desc: "Description", save: "Save",
                cash: "Cash", bank: "Bank", wallet: "Wallet"
            }
        };

        // --- CATEGORIES ---
        const categories = {
            income: [
                {val: 'clinic', txt: 'ğŸ¥ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (ÙŠÙˆÙ…ÙŠ)'},
                {val: 'teaching_1', txt: 'ğŸ“ ØªØ¯Ø±ÙŠØ³ - ÙØ±Ù‚Ø© 1'},
                {val: 'teaching_2', txt: 'ğŸ“ ØªØ¯Ø±ÙŠØ³ - ÙØ±Ù‚Ø© 2'},
                {val: 'consulting', txt: 'âš–ï¸ Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ù…Ø­Ø§Ø³Ø¨ÙŠØ©'},
                {val: 'asset_rent', txt: 'ğŸï¸ Ø¥ÙŠØ¬Ø§Ø± Ø¯Ø±Ø§Ø¬Ø©'},
                {val: 'other_in', txt: 'ğŸ’° Ø¥ÙŠØ±Ø§Ø¯ Ø¢Ø®Ø±'}
            ],
            expense: [
                {val: 'clinic_ops', txt: 'ğŸ¥ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (ØªØ´ØºÙŠÙ„/Ù…Ø±ØªØ¨Ø§Øª)'},
                {val: 'teaching_ops', txt: 'ğŸ“ Ø§Ù„ØªØ¯Ø±ÙŠØ³ (Ù…Ù†ØµØ©/Ø·Ø¨Ø§Ø¹Ø©)'},
                {val: 'home_rent', txt: 'ğŸ  Ø¥ÙŠØ¬Ø§Ø± Ù…Ù†Ø²Ù„ÙŠ'},
                {val: 'utilities', txt: 'ğŸ’¡ Ù…Ø±Ø§ÙÙ‚ (ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù†Øª)'},
                {val: 'subs', txt: 'ğŸ¬ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª (Netflix/Google)'},
                {val: 'family', txt: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ø¹Ø§Ø¦Ù„Ø© (Ø¯Ø±ÙˆØ³/ØªÙ…Ø§Ø±ÙŠÙ†)'},
                {val: 'personal', txt: 'ğŸ›’ Ø´Ø®ØµÙŠ (Ø·Ø¹Ø§Ù…/Ù…ÙˆØ§ØµÙ„Ø§Øª)'}
            ]
        };

        // --- INIT ---
        window.onload = function() {
            renderApp();
            updateChart();
            applyLang();
        };

        // --- CORE FUNCTIONS ---
        function renderApp() {
            // 1. Calculate Totals
            let total = 0, cash = 0, bank = 0, wallet = 0;
            let clinicIn = 0, clinicOut = 0;
            let teachingIn = 0, teachingOut = 0;

            const incList = document.getElementById('income-list-render');
            const expList = document.getElementById('expense-list-render');
            incList.innerHTML = ''; expList.innerHTML = '';

            transactions.forEach(t => {
                const amount = parseFloat(t.amount);
                
                // Balances
                if(t.type === 'income') {
                    total += amount;
                    if(t.method === 'cash') cash += amount;
                    if(t.method === 'bank') bank += amount;
                    if(t.method === 'wallet') wallet += amount;
                    
                    // Cost Centers
                    if(t.cat.includes('clinic')) clinicIn += amount;
                    if(t.cat.includes('teaching')) teachingIn += amount;

                    // Render List
                    incList.innerHTML += createItemHTML(t);

                } else {
                    total -= amount;
                    if(t.method === 'cash') cash -= amount;
                    if(t.method === 'bank') bank -= amount;
                    if(t.method === 'wallet') wallet -= amount;

                    if(t.cat.includes('clinic')) clinicOut += amount;
                    if(t.cat.includes('teaching')) teachingOut += amount;

                    expList.innerHTML += createItemHTML(t);
                }
            });

            // Update UI Balance
            document.getElementById('main-balance').dataset.val = total.toLocaleString() + ' Ø¬.Ù…';
            document.getElementById('cash-bal').innerText = cash.toLocaleString();
            document.getElementById('bank-bal').innerText = bank.toLocaleString();
            
            if(showBalance) document.getElementById('main-balance').innerText = document.getElementById('main-balance').dataset.val;

            // Update Profit Centers
            document.getElementById('clinic-in').innerText = clinicIn;
            document.getElementById('clinic-out').innerText = clinicOut;
            document.getElementById('clinic-profit').innerText = (clinicIn - clinicOut).toLocaleString() + ' Ø¬.Ù…';
            
            document.getElementById('teaching-in').innerText = teachingIn;
            document.getElementById('teaching-out').innerText = teachingOut;
            document.getElementById('teaching-profit').innerText = (teachingIn - teachingOut).toLocaleString() + ' Ø¬.Ù…';

            renderEvents();
        }

        function createItemHTML(t) {
            let color = t.type === 'income' ? 'var(--success)' : 'var(--danger)';
            let icon = t.type === 'income' ? '+' : '-';
            let catName = getCatName(t.cat, t.type);
            
            return `
            <div class="list-item">
                <div class="item-details">
                    <h4>${catName}</h4>
                    <p>${t.desc || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ'} | ${t.date}</p>
                </div>
                <div class="item-amount" style="color: ${color}">
                    ${icon}${parseFloat(t.amount).toLocaleString()}
                </div>
            </div>`;
        }

        function getCatName(val, type) {
            let found = categories[type].find(c => c.val === val);
            return found ? found.txt : val;
        }

        function renderEvents() {
            const fList = document.getElementById('financial-alerts-list');
            const eList = document.getElementById('events-list');
            fList.innerHTML = ''; eList.innerHTML = '';

            events.forEach((e, index) => {
                let html = `
                <div class="alert-card ${e.type === 'financial' ? 'alert-financial' : 'alert-event'}">
                    <div>
                        <div class="alert-title">${e.title}</div>
                        <div class="alert-date">${e.date} | ${e.time}</div>
                    </div>
                    <button class="alert-action" onclick="deleteEvent(${index})">
                        ${e.type === 'financial' ? 'ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…' : 'ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² âœ…'}
                    </button>
                </div>`;

                if(e.type === 'financial') fList.innerHTML += html;
                else eList.innerHTML += html;
            });
            
            if(fList.innerHTML === '') fList.innerHTML = '<div style="font-size:12px; opacity:0.5; padding:10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø§Ù„ÙŠØ©</div>';
        }

        // --- ACTIONS ---
        function openModal(id, type = null) {
            document.getElementById(id).style.display = 'flex';
            if(id === 'modal-trans' && type) {
                currentType = type;
                document.getElementById('trans-title').innerText = type === 'income' ? 'ØªØ³Ø¬ÙŠÙ„ Ø¥ÙŠØ±Ø§Ø¯ ğŸ’°' : 'ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ ğŸ’¸';
                
                // Populate Categories
                const sel = document.getElementById('t-category');
                sel.innerHTML = '';
                categories[type].forEach(c => {
                    let opt = document.createElement('option');
                    opt.value = c.val; opt.innerText = c.txt;
                    sel.appendChild(opt);
                });
            }
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }

        function selectMethod(el, method) {
            document.querySelectorAll('.pay-option').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            currentMethod = method;
        }

        function saveTransaction() {
            const amount = document.getElementById('t-amount').value;
            const cat = document.getElementById('t-category').value;
            const desc = document.getElementById('t-desc').value;
            const isDebt = document.getElementById('t-is-debt').checked;

            if(!amount) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº');

            // Debt Logic (Simplified for now)
            let finalDesc = desc;
            if(isDebt) finalDesc = `[Ø¯ÙŠÙ†/Ø³Ù„Ù] ${desc}`;

            const trans = {
                id: Date.now(),
                type: currentType,
                amount: amount,
                method: currentMethod,
                cat: cat,
                desc: finalDesc,
                date: new Date().toLocaleDateString('en-GB')
            };

            transactions.unshift(trans);
            localStorage.setItem('erp_trans', JSON.stringify(transactions));
            
            closeModal();
            renderApp();
            updateChart();
            
            // Clear inputs
            document.getElementById('t-amount').value = '';
            document.getElementById('t-desc').value = '';
        }

        function saveEvent() {
            const title = document.getElementById('e-title').value;
            const date = document.getElementById('e-date').value;
            const time = document.getElementById('e-time').value;
            const type = document.getElementById('e-type').value;

            if(!title) return;

            events.push({ title, date, time, type });
            localStorage.setItem('erp_events', JSON.stringify(events));
            closeModal();
            renderEvents();
        }

        function deleteEvent(index) {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                events.splice(index, 1);
                localStorage.setItem('erp_events', JSON.stringify(events));
                renderEvents();
            }
        }

        // --- UI UTILS ---
        function switchTab(tabId, navEl) {
            document.querySelectorAll('.list-container').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            navEl.classList.add('active');
        }

        function toggleBalance() {
            showBalance = !showBalance;
            const el = document.getElementById('main-balance');
            const icon = document.getElementById('eye-icon');
            
            if(showBalance) {
                el.innerText = el.dataset.val;
                icon.className = "fas fa-eye-slash";
            } else {
                el.innerText = "****";
                icon.className = "fas fa-eye";
            }
        }

        function toggleLang() {
            lang = lang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('erp_lang', lang);
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = lang;
            applyLang();
        }

        function applyLang() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(dict[lang][key]) el.innerText = dict[lang][key];
            });
        }

        // --- CHART ---
        function updateChart() {
            const ctx = document.getElementById('cashFlowChart').getContext('2d');
            
            // Calc logic for chart
            let inc = transactions.filter(t=>t.type==='income').reduce((a,b)=>a+parseFloat(b.amount),0);
            let exp = transactions.filter(t=>t.type==='expense').reduce((a,b)=>a+parseFloat(b.amount),0);

            if(window.myChart) window.myChart.destroy();
            
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [lang==='ar'?'Ø§Ù„Ø¯Ø®Ù„':'Income', lang==='ar'?'Ø§Ù„Ù…ØµØ±ÙˆÙ':'Expense'],
                    datasets: [{
                        label: 'Cash Flow',
                        data: [inc, exp],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderRadius: 10,
                        barThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { display: false },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    }
                }
            });
        }
    </script>
</body>
</html>
